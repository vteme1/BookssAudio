<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аудиоплеер для книг</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Improved select dropdown styling */
        select option {
            background-color: rgba(15, 23, 42, 0.95) !important;
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 8px !important;
        }
        
        select option:hover,
        select option:focus,
        select option:checked {
            background-color: rgba(59, 130, 246, 0.8) !important;
            color: white !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Smooth animations */
        * {
            transition: all 0.2s ease;
        }

        /* Focus improvements */
        button:focus,
        input:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }

        /* Hover effects */
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Progress bar improvements */
        .progress-bar {
            position: relative;
            cursor: pointer;
        }

        .progress-bar:hover .progress-thumb {
            opacity: 1;
            transform: scale(1.2);
        }

        .progress-thumb {
            position: absolute;
            top: 50%;
            right: 0;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transform: translateY(-50%) scale(0);
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Button improvements */
        .btn-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(147, 51, 234, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(147, 51, 234, 1));
            border-color: rgba(59, 130, 246, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Card hover effects */
        .book-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-2 sm:p-6">
    <div class="max-w-sm sm:max-w-2xl lg:max-w-4xl xl:max-w-6xl mx-auto space-y-4 sm:space-y-6">
        
        <!-- Header -->
        <header class="glass-effect bg-white/10 rounded-3xl p-4 sm:p-6 border border-white/20 hover-lift">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl border border-white/20">
                        <i data-lucide="headphones" class="w-8 h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-white">Аудиоплеер</h1>
                        <p class="text-white/60 text-sm">Ваша личная библиотека</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button onclick="openModal('recommendationsModal')" class="btn-secondary p-3 rounded-xl hover-lift relative" title="Рекомендации">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-white"></i>
                        <div id="recommendationsBadge" class="absolute -top-1 -right-1 bg-blue-400 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden">
                            <span class="text-xs">!</span>
                        </div>
                    </button>
                    
                    <button onclick="openModal('achievementsModal')" class="btn-secondary p-3 rounded-xl hover-lift relative" title="Достижения">
                        <i data-lucide="trophy" class="w-5 h-5 text-white"></i>
                        <div id="achievementsBadge" class="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden"></div>
                    </button>
                    
                    <button onclick="openModal('bookmarksModal')" class="btn-secondary p-3 rounded-xl hover-lift" title="Закладки">
                        <i data-lucide="bookmark-check" class="w-5 h-5 text-white"></i>
                    </button>
                    
                    <button onclick="openModal('addModal')" class="btn-primary p-3 rounded-xl hover-lift" title="Добавить книгу">
                        <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                    </button>
                    
                    <button onclick="openModal('settingsModal')" class="btn-secondary p-3 rounded-xl hover-lift" title="Настройки">
                        <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
            </div>

            <!-- Current Book Player -->
            <div id="playerSection" class="hidden">
                <div class="bg-gradient-to-r from-white/5 to-white/10 rounded-2xl p-6 border border-white/10">
                    <div class="flex items-start space-x-6 mb-6">
                        <div class="flex-shrink-0">
                            <img id="bookCover" class="w-24 h-32 sm:w-32 sm:h-40 rounded-2xl object-cover shadow-2xl border border-white/20 hidden">
                            <div id="defaultCover" class="w-24 h-32 sm:w-32 sm:h-40 rounded-2xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/20 flex items-center justify-center">
                                <i data-lucide="music" class="w-12 h-12 text-white/60"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h2 id="bookTitle" class="text-xl sm:text-2xl font-bold text-white mb-2 line-clamp-2"></h2>
                            <p id="bookAuthor" class="text-white/70 text-base sm:text-lg mb-4"></p>
                            
                            <!-- Chapter selector with bookmark button -->
                            <div class="flex items-center space-x-3 mb-4">
                                <select id="chapterSelect" class="flex-1 bg-white/20 border border-white/30 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                </select>
                                <button onclick="createBookmark()" class="btn-secondary p-3 rounded-xl hover-lift" title="Создать закладку">
                                    <i data-lucide="bookmark-plus" class="w-5 h-5 text-yellow-300"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Series Navigation -->
                    <div id="seriesNavigation" class="hidden mb-6">
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between">
                                <button id="prevBookBtn" onclick="goToPrevBookInSeries()" class="btn-secondary px-4 py-2 rounded-xl disabled:opacity-50 hover-lift flex items-center space-x-2">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                    <span class="hidden sm:inline">Предыдущая</span>
                                </button>
                                
                                <div class="text-center px-4">
                                    <div class="text-white/60 text-sm">Серия</div>
                                    <div id="currentSeriesName" class="text-white font-medium"></div>
                                </div>
                                
                                <button id="nextBookBtn" onclick="goToNextBookInSeries()" class="btn-secondary px-4 py-2 rounded-xl disabled:opacity-50 hover-lift flex items-center space-x-2">
                                    <span class="hidden sm:inline">Следующая</span>
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Progress bar -->
                    <div class="mb-6">
                        <div id="progressBar" class="progress-bar w-full bg-white/20 rounded-full h-3 cursor-pointer hover-lift">
                            <div id="progressFill" class="bg-gradient-to-r from-blue-400 to-purple-400 h-3 rounded-full relative" style="width: 0%">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm text-white/80 mt-3">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-4 mb-6">
                        <button onclick="prevChapter()" id="prevBtn" class="btn-secondary p-3 rounded-xl disabled:opacity-50 hover-lift">
                            <i data-lucide="skip-back" class="w-6 h-6 text-white"></i>
                        </button>

                        <button onclick="skipTime(-10)" class="btn-secondary p-2 rounded-xl hover-lift">
                            <span class="text-white text-sm font-bold">-10</span>
                        </button>

                        <button onclick="togglePlay()" id="playBtn" class="btn-primary p-4 rounded-2xl hover-lift shadow-lg">
                            <i data-lucide="play" class="w-8 h-8 text-white"></i>
                        </button>

                        <button onclick="skipTime(10)" class="btn-secondary p-2 rounded-xl hover-lift">
                            <span class="text-white text-sm font-bold">+10</span>
                        </button>

                        <button onclick="nextChapter()" id="nextBtn" class="btn-secondary p-3 rounded-xl disabled:opacity-50 hover-lift">
                            <i data-lucide="skip-forward" class="w-6 h-6 text-white"></i>
                        </button>
                    </div>

                    <!-- Volume and Speed Controls -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="volume-2" class="w-5 h-5 text-white"></i>
                                    <span class="text-white text-sm font-medium">Громкость</span>
                                </div>
                                <span id="volumeDisplay" class="text-white/70 text-sm font-mono">100%</span>
                            </div>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-full">
                        </div>
                        
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="gauge" class="w-5 h-5 text-white"></i>
                                    <span class="text-white text-sm font-medium">Скорость</span>
                                </div>
                            </div>
                            <select id="speedSelect" class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="text-center py-12">
                <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-3xl flex items-center justify-center border border-white/10">
                    <i data-lucide="music" class="w-12 h-12 text-white/40"></i>
                </div>
                <h3 class="text-xl text-white/70 mb-2">Выберите аудиокнигу</h3>
                <p class="text-white/50">или добавьте новую в свою библиотеку</p>
            </div>
        </header>

        <!-- Recommendations Block -->
        <section id="recommendationsBlock" class="glass-effect bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-3xl p-4 sm:p-6 border border-blue-400/20 hover-lift">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-xl mr-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-blue-300"></i>
                    </div>
                    <span>Рекомендации для вас</span>
                </h2>
                <button onclick="toggleRecommendationsBlock()" class="btn-secondary p-2 rounded-lg hover-lift" title="Скрыть рекомендации">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="quickRecommendations" class="grid gap-4">
                <!-- Recommendations content will be inserted here -->
            </div>
        </section>

        <!-- Library -->
        <section class="glass-effect bg-white/10 rounded-3xl p-4 sm:p-6 border border-white/20 hover-lift">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-green-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="library" class="w-5 h-5"></i>
                    </div>
                    <span id="libraryTitle">Библиотека (0)</span>
                </h2>
                
                <div class="flex items-center space-x-2">
                    <button onclick="toggleSeriesView()" id="seriesViewBtn" class="btn-secondary p-2 rounded-lg hover-lift" title="Показать серии">
                        <i data-lucide="layers" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div id="searchFilters" class="space-y-4 mb-6">
                <!-- Search -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-white/60"></i>
                    <input type="text" id="searchInput" placeholder="Поиск книг, авторов и серий..." class="w-full bg-white/10 border border-white/20 rounded-2xl pl-12 pr-12 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button onclick="clearSearch()" id="clearSearchBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors hidden">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Series Filter -->
                <div id="seriesFilter" class="flex space-x-2 overflow-x-auto pb-2 hidden">
                    <button onclick="filterBySeries(null)" class="btn-primary px-4 py-2 rounded-xl text-sm whitespace-nowrap" id="allBooksBtn">
                        Все книги
                    </button>
                </div>
            </div>
            
            <!-- Books list -->
            <div id="booksList" class="grid gap-4">
                <div id="emptyLibrary" class="text-center py-12">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="book-open" class="w-10 h-10 text-white/40"></i>
                    </div>
                    <h3 class="text-xl text-white/70 mb-4">Библиотека пуста</h3>
                    
                    <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-400/20 rounded-2xl p-6 max-w-md mx-auto">
                        <h4 class="text-white font-semibold mb-4 flex items-center justify-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                            Как добавить книги
                        </h4>
                        <div class="text-white/80 text-sm space-y-3 text-left">
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">1</span>
                                </div>
                                <p>Нажмите кнопку "+" в верхней панели</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">2</span>
                                </div>
                                <p>Заполните информацию о книге</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">3</span>
                                </div>
                                <p>Добавьте MP3 файлы или ссылки на главы</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Book Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-green-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    Добавить новую книгу
                </h3>
                <button onclick="closeModal('addModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="newBookTitle" placeholder="Название книги" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="text" id="newBookAuthor" placeholder="Автор" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                
                <input type="url" id="newBookCover" placeholder="Ссылка на обложку (необязательно)" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <input type="text" id="newBookSeries" placeholder="Название серии (необязательно)" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <input type="number" id="newBookSeriesOrder" placeholder="Номер в серии" min="1" value="1" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center">
                    </div>
                </div>
                
                <div>
                    <label class="text-white font-semibold text-lg mb-4 block">Добавить главы:</label>
                    
                    <!-- Upload Options -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="relative">
                            <input
                                type="file"
                                accept=".mp3,audio/mpeg,audio/mp3"
                                multiple
                                id="massUpload"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                            />
                            <label
                                for="massUpload"
                                class="btn-primary w-full rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2 cursor-pointer"
                            >
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>MP3 файлы</span>
                            </label>
                        </div>

                        <div
                            id="dropZone"
                            class="btn-secondary border-2 border-dashed border-white/30 rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2"
                        >
                            <i data-lucide="move-3d" class="w-5 h-5"></i>
                            <span>Перетащить</span>
                        </div>

                        <button
                            onclick="toggleBulkLinks()"
                            class="btn-secondary rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2"
                        >
                            <i data-lucide="link" class="w-5 h-5"></i>
                            <span>Из ссылок</span>
                        </button>
                    </div>

                    <!-- Bulk Links Container -->
                    <div id="bulkLinksContainer" class="mb-6 hidden">
                        <div class="bg-white/5 border border-white/20 rounded-2xl p-4">
                            <textarea
                                id="bulkLinksText"
                                placeholder="Вставьте ссылки на главы (каждая ссылка с новой строки):
https://example.com/chapter1.mp3
https://example.com/chapter2.mp3
..."
                                class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm resize-none"
                                rows="6"
                            ></textarea>
                            <div class="flex space-x-3 mt-4">
                                <button
                                    onclick="processBulkLinks()"
                                    class="btn-primary flex-1 rounded-xl px-4 py-3 text-white hover-lift flex items-center justify-center space-x-2"
                                >
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span>Загрузить ссылки</span>
                                </button>
                                <button
                                    onclick="clearBulkLinks()"
                                    class="btn-secondary px-4 py-3 rounded-xl text-white hover-lift"
                                >
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="bg-white/10 border border-white/20 rounded-2xl p-4 mb-6 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-white font-medium">Загрузка файлов...</span>
                            <span id="progressText" class="text-white font-mono">0%</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3">
                            <div
                                id="progressBar"
                                class="bg-gradient-to-r from-green-400 to-blue-400 h-3 rounded-full transition-all duration-300"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>

                    <!-- Info Card -->
                    <div class="bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-400/20 rounded-2xl p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="p-2 bg-purple-500/20 rounded-lg">
                                <i data-lucide="info" class="w-5 h-5 text-purple-300"></i>
                            </div>
                            <div>
                                <h4 class="text-white font-medium mb-2">Способы добавления глав</h4>
                                <ul class="text-purple-200 text-sm space-y-1">
                                    <li>• <strong>MP3 файлы:</strong> Выберите файлы с компьютера</li>
                                    <li>• <strong>Перетаскивание:</strong> Просто перетащите файлы в область</li>
                                    <li>• <strong>Ссылки:</strong> Вставьте URL на аудиофайлы</li>
                                    <li>• <strong>Вручную:</strong> Добавьте ссылки по одной</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Chapter Addition -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-white font-medium">Или добавьте главы вручную:</span>
                        </div>
                        
                        <div id="chaptersContainer">
                            <div class="chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white font-medium">Глава 1</span>
                                    <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg opacity-0 pointer-events-none">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="url" placeholder="Ссылка на MP3 файл" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                        </div>
                        
                        <button onclick="addChapter()" class="btn-secondary w-full border-2 border-dashed border-white/30 rounded-2xl py-4 text-white hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Добавить главу
                        </button>
                    </div>
                </div>

                <div class="flex space-x-4 pt-6">
                    <button onclick="closeModal('addModal')" class="btn-secondary flex-1 rounded-2xl py-4 text-white hover-lift">
                        Отмена
                    </button>
                    <button onclick="addBook()" class="btn-primary flex-1 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="check" class="w-5 h-5 mr-2"></i>
                        Добавить книгу
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-md border border-white/30">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-gray-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </div>
                    Настройки
                </h3>
                <button onclick="closeModal('settingsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-4">
                <button onclick="exportData()" class="w-full btn-primary rounded-2xl px-6 py-4 text-white hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Экспорт библиотеки</span>
                </button>

                <div class="relative">
                    <input type="file" id="importFile" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div class="w-full btn-secondary rounded-2xl px-6 py-4 text-white hover-lift flex items-center justify-center space-x-3 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span>Импорт библиотеки</span>
                    </div>
                </div>

                <button onclick="openLinkCollector()" class="w-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-2xl px-6 py-4 text-white hover:from-purple-500/30 hover:to-pink-500/30 transition-all hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="link" class="w-5 h-5"></i>
                    <span>Сборщик ссылок</span>
                </button>

                <button onclick="clearAllData()" class="w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-400/40 rounded-2xl px-6 py-4 text-red-200 hover:from-red-500/30 hover:to-orange-500/30 transition-all hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>Очистить все данные</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-xl mr-3">
                        <i data-lucide="edit-3" class="w-6 h-6"></i>
                    </div>
                    Редактировать книгу
                </h3>
                <button onclick="closeModal('editModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="editBookTitle" placeholder="Название книги" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="text" id="editBookAuthor" placeholder="Автор" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                
                <input type="url" id="editBookCover" placeholder="Ссылка на обложку" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <input type="text" id="editBookSeries" placeholder="Название серии" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <input type="number" id="editBookSeriesOrder" placeholder="№" min="1" value="1" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center">
                    </div>
                </div>

                <div>
                    <label class="text-white font-semibold text-lg mb-4 block">Главы:</label>
                    <div id="editChaptersContainer"></div>
                    <button onclick="addEditChapter()" class="w-full btn-secondary border-2 border-dashed border-white/30 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Добавить главу
                    </button>
                </div>

                <div class="flex space-x-4 pt-6">
                    <button onclick="closeModal('editModal')" class="btn-secondary flex-1 rounded-2xl py-4 text-white hover-lift">
                        Отмена
                    </button>
                    <button onclick="saveEditedBook()" class="btn-primary flex-1 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Modal -->
    <div id="recommendationsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-4xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-blue-300"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">Персональные рекомендации</h3>
                </div>
                <button onclick="closeModal('recommendationsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Statistics -->
            <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-400/20 rounded-2xl p-6 mb-6">
                <h4 class="text-white font-semibold mb-4 flex items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-3"></i>
                    Статистика чтения
                </h4>
                <div id="statsGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div id="totalBooksCount" class="text-3xl font-bold text-white mb-1">0</div>
                        <div class="text-white/70 text-sm">Всего книг</div>
                    </div>
                    <div class="text-center">
                        <div id="completedBooksCount" class="text-3xl font-bold text-green-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">Прослушано</div>
                    </div>
                    <div class="text-center">
                        <div id="inProgressBooksCount" class="text-3xl font-bold text-yellow-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">В процессе</div>
                    </div>
                    <div class="text-center">
                        <div id="unlistenedBooksCount" class="text-3xl font-bold text-blue-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">Не начато</div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <div class="flex justify-between text-sm text-white/80 mb-3">
                        <span>Прогресс завершения</span>
                        <span id="completionRate">0%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-3">
                        <div id="completionBar" class="bg-gradient-to-r from-green-400 to-blue-400 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="recommendationsList" class="space-y-6">
                <div id="emptyRecommendations" class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="lightbulb" class="w-12 h-12 text-white/30"></i>
                    </div>
                    <h4 class="text-xl text-white/60 mb-4">Пока нет рекомендаций</h4>
                    <p class="text-white/50 max-w-md mx-auto">Послушайте несколько книг, чтобы получить персональные рекомендации на основе ваших предпочтений!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-4xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-yellow-500/30 to-orange-500/30 rounded-2xl">
                        <i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">Достижения</h3>
                </div>
                <button onclick="closeModal('achievementsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-400/20 rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-white font-semibold">Общий прогресс</h4>
                    <span id="achievementStats" class="text-white font-bold text-lg">0/108</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-4">
                    <div id="achievementProgress" class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="text-center mt-3">
                    <span id="achievementPercentage" class="text-yellow-400 font-bold text-2xl">0%</span>
                    <span class="text-white/60 text-sm ml-2">завершено</span>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h4 class="text-white font-semibold text-lg mb-4 flex items-center">
                        <i data-lucide="star" class="w-6 h-6 mr-3 text-yellow-400"></i>
                        Разблокированные достижения
                    </h4>
                    
                    <div id="unlockedAchievements" class="space-y-4">
                        <div id="emptyAchievements" class="text-center py-16">
                            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-3xl flex items-center justify-center">
                                <i data-lucide="trophy" class="w-12 h-12 text-white/30"></i>
                            </div>
                            <h4 class="text-xl text-white/60 mb-4">Достижений пока нет</h4>
                            <p class="text-white/50 max-w-md mx-auto">Слушайте книги и исследуйте функции плеера, чтобы разблокировать награды!</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-white font-semibold text-lg mb-4 flex items-center">
                        <i data-lucide="lock" class="w-6 h-6 mr-3 text-white/40"></i>
                        Заблокированные достижения
                    </h4>
                    
                    <div id="lockedAchievements" class="grid gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div id="bookmarksModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl">
                        <i data-lucide="bookmark-check" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">Закладки</h3>
                </div>
                <button onclick="closeModal('bookmarksModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="bookmarksList" class="space-y-4">
                <div id="emptyBookmarks" class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="bookmark-check" class="w-12 h-12 text-white/30"></i>
                    </div>
                    <h4 class="text-xl text-white/60 mb-4">Нет сохраненных закладок</h4>
                    <p class="text-white/50 max-w-sm mx-auto">Закладки создаются автоматически во время прослушивания или вручную</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Notification -->
    <div id="achievementNotification" class="fixed top-6 right-6 z-[60] hidden">
        <div class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-4 border border-yellow-400/40 max-w-sm shadow-2xl hover-lift">
            <div class="flex items-center space-x-3">
                <div id="achievementIcon" class="text-4xl">🏆</div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <i data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i>
                        <span class="text-white font-bold">Достижение разблокировано!</span>
                    </div>
                    <h4 id="achievementName" class="text-white font-semibold mb-1"></h4>
                    <p id="achievementDescription" class="text-white/80 text-sm mb-1"></p>
                    <span id="achievementRarity" class="text-white/60 text-xs bg-white/20 px-2 py-1 rounded-full"></span>
                </div>
                <button onclick="hideAchievementNotification()" class="btn-secondary p-1 rounded-lg">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global state
        let audiobooks = [];
        let currentBook = null;
        let currentChapter = 0;
        let isPlaying = false;
        let bookmarks = {};
        let achievements = [];
        let editingBook = null;
        let showSeriesView = false;
        let selectedSeries = null;
        let searchQuery = '';
        
        // Safe localStorage wrapper
        function safeLocalStorage() {
            try {
                return typeof localStorage !== 'undefined' ? localStorage : null;
            } catch (e) {
                console.warn('localStorage not available:', e);
                return null;
            }
        }
        
        // Safe storage functions
        function getStorageItem(key, defaultValue = null) {
            const storage = safeLocalStorage();
            if (!storage) return defaultValue;
            
            try {
                const item = storage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.warn('Error reading from storage:', e);
                return defaultValue;
            }
        }
        
        function setStorageItem(key, value) {
            const storage = safeLocalStorage();
            if (!storage) return false;
            
            try {
                storage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.warn('Error writing to storage:', e);
                return false;
            }
        }

        // Initialize data from localStorage
        function initializeData() {
            audiobooks = getStorageItem('audiobooks', []);
            bookmarks = getStorageItem('bookmarks', {});
            achievements = getStorageItem('achievements', []);
        }
        
        const audio = document.getElementById('audioPlayer');
        
        // DOM elements
        const playerSection = document.getElementById('playerSection');
        const emptyState = document.getElementById('emptyState');
        const bookTitle = document.getElementById('bookTitle');
        const bookAuthor = document.getElementById('bookAuthor');
        const bookCover = document.getElementById('bookCover');
        const defaultCover = document.getElementById('defaultCover');
        const chapterSelect = document.getElementById('chapterSelect');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const durationSpan = document.getElementById('duration');
        const playBtn = document.getElementById('playBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const speedSelect = document.getElementById('speedSelect');
        const searchInput = document.getElementById('searchInput');
        const booksList = document.getElementById('booksList');
        const libraryTitle = document.getElementById('libraryTitle');
        const emptyLibrary = document.getElementById('emptyLibrary');

        // Utility functions
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function saveData() {
            setStorageItem('audiobooks', audiobooks);
            setStorageItem('bookmarks', bookmarks);
            setStorageItem('achievements', achievements);
        }

        function safeStringTrim(value) {
            if (value === null || value === undefined) return '';
            if (typeof value !== 'string') {
                console.warn('Attempting to trim non-string value:', typeof value, value);
                return String(value).trim();
            }
            return value.trim();
        }

        function showSuccess(message) {
            // Create a modern toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-6 right-6 bg-gradient-to-r from-green-400/20 to-blue-500/20 backdrop-blur-lg rounded-2xl p-4 border border-green-400/40 shadow-2xl z-50 hover-lift';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-green-500/20 rounded-xl">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            // Create a modern error notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-6 right-6 bg-gradient-to-r from-red-400/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-4 border border-red-400/40 shadow-2xl z-50 hover-lift';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-red-500/20 rounded-xl">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 4000);
            }, 4000);
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }
            modal.classList.remove('hidden');
            
            // Load content when opening modals
            switch(modalId) {
                case 'bookmarksModal':
                    renderBookmarks();
                    break;
                case 'recommendationsModal':
                    renderRecommendations();
                    break;
                case 'achievementsModal':
                    renderAchievements();
                    break;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'addModal') {
                resetAddForm();
            }
        }

        // Audio functions
        function selectBook(bookId) {
            if (!audiobooks || !Array.isArray(audiobooks)) return;
            
            currentBook = audiobooks.find(book => book && book.id === bookId);
            if (!currentBook) {
                console.error('Book not found:', bookId);
                return;
            }
            
            currentChapter = 0;
            updatePlayer();
            loadChapter();
        }

        function updatePlayer() {
            if (!currentBook || !playerSection || !emptyState) {
                if (playerSection) playerSection.classList.add('hidden');
                if (emptyState) emptyState.classList.remove('hidden');
                const seriesNav = document.getElementById('seriesNavigation');
                if (seriesNav) seriesNav.classList.add('hidden');
                return;
            }

            playerSection.classList.remove('hidden');
            emptyState.classList.add('hidden');

            bookTitle.textContent = currentBook.title;
            bookAuthor.textContent = currentBook.author;
            
            if (currentBook.cover) {
                bookCover.src = currentBook.cover;
                bookCover.classList.remove('hidden');
                defaultCover.classList.add('hidden');
            } else {
                bookCover.classList.add('hidden');
                defaultCover.classList.remove('hidden');
            }

            // Update chapter select
            chapterSelect.innerHTML = '';
            currentBook.chapters.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${chapter.title}`;
                chapterSelect.appendChild(option);
            });
            chapterSelect.value = currentChapter;

            // Update series navigation
            updateSeriesNavigation();

            updateControls();
        }

        function updateSeriesNavigation() {
            const seriesNav = document.getElementById('seriesNavigation');
            const seriesName = document.getElementById('currentSeriesName');
            const prevBtn = document.getElementById('prevBookBtn');
            const nextBtn = document.getElementById('nextBookBtn');

            if (currentBook && currentBook.series) {
                seriesNav.classList.remove('hidden');
                seriesName.textContent = `${currentBook.series} #${currentBook.seriesOrder || 1}`;

                const prevBook = getPrevBookInSeries(currentBook);
                const nextBook = getNextBookInSeries(currentBook);

                prevBtn.disabled = !prevBook;
                nextBtn.disabled = !nextBook;
            } else {
                seriesNav.classList.add('hidden');
            }
        }

        function updateControls() {
            document.getElementById('prevBtn').disabled = currentChapter === 0;
            document.getElementById('nextBtn').disabled = currentChapter === currentBook.chapters.length - 1;
        }

        function loadChapter() {
            if (!currentBook || !currentBook.chapters || !currentBook.chapters[currentChapter]) {
                console.error('Cannot load chapter: invalid book or chapter');
                return;
            }
            
            try {
                // Останавливаем текущее воспроизведение
                if (!audio.paused) {
                    audio.pause();
                }
                isPlaying = false;
                
                const chapter = currentBook.chapters[currentChapter];
                if (!chapter || !chapter.url) {
                    console.error('Invalid chapter data');
                    showError('Неверные данные главы');
                    return;
                }
                
                console.log('Loading chapter:', chapter.title, chapter.url);
                
                // Очищаем старый источник
                audio.src = '';
                
                // Устанавливаем новый источник и загружаем
                audio.src = chapter.url;
                audio.load();
                
                // Принудительно обновляем кнопку воспроизведения
                setTimeout(() => {
                    updatePlayButton();
                }, 100);
                
                // Восстанавливаем сохраненную позицию
                const savedTime = getSavedTime();
                if (savedTime > 0) {
                    audio.addEventListener('loadedmetadata', () => {
                        if (audio.duration && savedTime < audio.duration) {
                            audio.currentTime = savedTime;
                            console.log('Restored position:', formatTime(savedTime));
                        }
                    }, { once: true });
                }
                
            } catch (error) {
                console.error('Error loading chapter:', error);
                showError('Ошибка загрузки главы');
            }
        }

        function togglePlay() {
            if (!currentBook) {
                showError('Сначала выберите книгу для воспроизведения');
                return;
            }
            
            if (!audio.src || audio.src === '') {
                showError('Не удается загрузить аудиофайл');
                return;
            }
            
            console.log('Toggle play clicked. Current state:', isPlaying);
            
            if (isPlaying) {
                audio.pause();
                // Состояние обновится через событие 'pause'
            } else {
                // Показываем индикатор загрузки
                const playButton = document.getElementById('playBtn');
                playButton.innerHTML = '<i data-lucide="loader" class="w-6 h-6 sm:w-8 sm:h-8 text-white animate-spin"></i>';
                lucide.createIcons();
                
                audio.play().then(() => {
                    console.log('Audio started successfully');
                    // Состояние обновится через событие 'play'
                }).catch(error => {
                    console.error('Playback error:', error);
                    isPlaying = false;
                    updatePlayButton();
                    showError('Ошибка воспроизведения. Проверьте ссылку на файл.');
                });
            }
        }

        function updatePlayButton() {
            const playButton = document.getElementById('playBtn');
            if (!playButton) {
                console.error('Play button not found');
                return;
            }
            
            // Определяем нужную иконку
            const iconName = isPlaying ? 'pause' : 'play';
            
            // Полностью заменяем содержимое кнопки
            playButton.innerHTML = `<i data-lucide="${iconName}" class="w-6 h-6 sm:w-8 sm:h-8 text-white"></i>`;
            
            // Обновляем иконки Lucide
            lucide.createIcons();
            
            console.log('Play button updated. Is playing:', isPlaying, 'Icon:', iconName);
        }

        function skipTime(seconds) {
            if (!audio.src) return;
            audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration || 0));
        }

        function prevChapter() {
            if (currentChapter > 0) {
                currentChapter--;
                chapterSelect.value = currentChapter;
                loadChapter();
                updateControls();
            }
        }

        function nextChapter() {
            if (currentChapter < currentBook.chapters.length - 1) {
                currentChapter++;
                chapterSelect.value = currentChapter;
                loadChapter();
                updateControls();
            }
        }

        function seekTo(percentage) {
            if (!audio.duration) return;
            audio.currentTime = (percentage / 100) * audio.duration;
        }

        // Bookmark functions
        function getSavedTime() {
            if (!currentBook) return 0;
            const key = `${currentBook.id}_${currentChapter}`;
            return bookmarks[key] || 0;
        }

        function saveProgress() {
            if (!currentBook || !audio.currentTime) return;
            const key = `${currentBook.id}_${currentChapter}`;
            bookmarks[key] = audio.currentTime;
            saveData();
            // Обновляем рекомендации при изменении прогресса
            renderQuickRecommendations();
        }

        function createBookmark() {
            if (!currentBook || !audio.currentTime) return;
            saveProgress();
            showSuccess(`Закладка создана на ${formatTime(audio.currentTime)}`);
        }

        // Library functions - improved with better styling
        function renderLibrary() {
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const filteredBooks = audiobooks.filter(book => 
                book && book.title && book.author &&
                (book.title.toLowerCase().includes(searchTerm) ||
                 book.author.toLowerCase().includes(searchTerm))
            );

            libraryTitle.textContent = `Библиотека (${filteredBooks.length})`;

            if (filteredBooks.length === 0) {
                if (searchTerm) {
                    booksList.innerHTML = `
                        <div class="text-center py-16">
                            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-3xl flex items-center justify-center">
                                <i data-lucide="search-x" class="w-10 h-10 text-white/40"></i>
                            </div>
                            <h4 class="text-xl text-white/60 mb-4">Книги не найдены</h4>
                            <p class="text-white/50 mb-6">Попробуйте изменить запрос</p>
                            <button onclick="searchInput.value=''; renderLibrary();" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                                Показать все книги
                            </button>
                        </div>
                    `;
                } else {
                    booksList.innerHTML = emptyLibrary.outerHTML;
                }
                return;
            }

            const booksHtml = filteredBooks.map(book => {
                const isCurrentBook = currentBook?.id === book.id;
                const hasProgress = Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 60;
                });
                
                return `
                    <div class="book-card p-6 rounded-3xl border cursor-pointer ${
                        isCurrentBook 
                            ? 'bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-blue-400/40' 
                            : 'bg-white/10 border-white/20 hover:bg-white/15'
                    }" onclick="selectBook(${book.id})">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                ${book.cover ? 
                                    `<img src="${book.cover}" alt="${book.title}" class="w-16 h-20 sm:w-20 sm:h-28 rounded-2xl object-cover shadow-lg border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                    ''}
                                <div class="w-16 h-20 sm:w-20 sm:h-28 rounded-2xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/30 flex flex-col items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                    <i data-lucide="music" class="w-6 h-6 text-white/60 mb-2"></i>
                                    <span class="text-white/50 text-xs text-center px-1 leading-tight line-clamp-2">
                                        ${book.title}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white text-lg mb-2 line-clamp-2">
                                    ${book.title}
                                </h4>
                                <p class="text-white/70 text-sm mb-3 line-clamp-1">${book.author}</p>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-sm text-white/60 space-x-4">
                                        <div class="flex items-center space-x-1">
                                            <i data-lucide="headphones" class="w-4 h-4"></i>
                                            <span>${book.chapters.length} глав</span>
                                        </div>
                                        
                                        ${hasProgress ? `
                                            <div class="flex items-center space-x-1 text-yellow-400">
                                                <i data-lucide="bookmark-check" class="w-4 h-4"></i>
                                                <span>В процессе</span>
                                            </div>
                                        ` : ''}
                                        
                                        ${book.series ? `
                                            <div class="flex items-center space-x-1 text-purple-400">
                                                <i data-lucide="layers" class="w-4 h-4"></i>
                                                <span>${book.series} #${book.seriesOrder || 1}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        <button onclick="event.stopPropagation(); editBook(${book.id})" class="btn-secondary p-2 rounded-xl hover-lift" title="Редактировать">
                                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteBook(${book.id})" class="bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 p-2 rounded-xl hover-lift transition-all" title="Удалить">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            booksList.innerHTML = booksHtml;
            lucide.createIcons();
        }

        function deleteBook(bookId) {
            if (!confirm('Удалить эту аудиокнигу из библиотеки?')) return;
            
            if (!audiobooks || !Array.isArray(audiobooks)) {
                showError('Ошибка: библиотека не найдена');
                return;
            }
            
            audiobooks = audiobooks.filter(book => book && book.id !== bookId);
            if (currentBook?.id === bookId) {
                currentBook = null;
                audio.pause();
                isPlaying = false;
                updatePlayer();
            }
            
            saveData();
            renderLibrary();
            renderQuickRecommendations();
            showSuccess('Книга удалена из библиотеки!');
        }

        // Enhanced chapter management
        function addChapter() {
            const container = document.getElementById('chaptersContainer');
            const chapterCount = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-white font-medium">Глава ${chapterCount}</span>
                    <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <input type="url" placeholder="Ссылка на MP3 файл" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
            `;
            container.appendChild(div);
            lucide.createIcons();
            updateChapterButtons();
        }

        function removeChapter(button) {
            if (document.querySelectorAll('.chapter-input').length > 1) {
                button.closest('.chapter-input').remove();
                updateChapterNumbers();
                updateChapterButtons();
            }
        }

        function updateChapterNumbers() {
            const chapters = document.querySelectorAll('.chapter-input');
            chapters.forEach((chapter, index) => {
                const span = chapter.querySelector('span');
                const input = chapter.querySelector('input');
                if (span) span.textContent = `Глава ${index + 1}`;
                if (input) input.placeholder = `Ссылка на MP3 файл главы ${index + 1}`;
            });
        }

        function updateChapterButtons() {
            const buttons = document.querySelectorAll('.chapter-input button');
            buttons.forEach((button, index) => {
                if (buttons.length === 1) {
                    button.style.opacity = '0.5';
                    button.disabled = true;
                } else {
                    button.style.opacity = '1';
                    button.disabled = false;
                }
            });
        }

        function resetAddForm() {
            document.getElementById('newBookTitle').value = '';
            document.getElementById('newBookAuthor').value = '';
            document.getElementById('newBookCover').value = '';
            document.getElementById('newBookSeries').value = '';
            document.getElementById('newBookSeriesOrder').value = '1';
            
            const container = document.getElementById('chaptersContainer');
            container.innerHTML = `
                <div class="chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">Глава 1</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg opacity-50" disabled>
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="url" placeholder="Ссылка на MP3 файл" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            `;
            
            // Clear bulk links
            const bulkContainer = document.getElementById('bulkLinksContainer');
            const bulkText = document.getElementById('bulkLinksText');
            if (bulkContainer) bulkContainer.classList.add('hidden');
            if (bulkText) bulkText.value = '';
            
            lucide.createIcons();
        }

        // Enhanced add book function
        function addBook() {
            const titleElement = document.getElementById('newBookTitle');
            const authorElement = document.getElementById('newBookAuthor');
            const coverElement = document.getElementById('newBookCover');
            const seriesElement = document.getElementById('newBookSeries');
            const seriesOrderElement = document.getElementById('newBookSeriesOrder');
            
            if (!titleElement || !authorElement) {
                showError('Ошибка: не найдены элементы формы');
                return;
            }
            
            const title = safeStringTrim(titleElement.value);
            const author = safeStringTrim(authorElement.value) || 'Неизвестный автор';
            const cover = coverElement ? safeStringTrim(coverElement.value) : '';
            const series = seriesElement ? safeStringTrim(seriesElement.value) : '';
            const seriesOrder = seriesOrderElement ? parseInt(seriesOrderElement.value) || 1 : 1;
            
            if (!title) {
                showError('Введите название книги');
                return;
            }

            const chapterInputs = document.querySelectorAll('.chapter-input input[type="url"]');
            const chapters = [];
            
            chapterInputs.forEach((input, index) => {
                const url = safeStringTrim(input.value);
                if (url) {
                    chapters.push({
                        title: `Глава ${index + 1}`,
                        url: url
                    });
                }
            });

            if (chapters.length === 0) {
                showError('Добавьте хотя бы одну главу');
                return;
            }

            const audiobook = {
                id: Date.now(),
                title: title,
                author: author,
                cover: cover || null,
                chapters: chapters,
                addedDate: new Date().toISOString(),
                series: series || null,
                seriesOrder: series ? seriesOrder : null
            };

            audiobooks.push(audiobook);
            saveData();
            renderLibrary();
            renderQuickRecommendations();
            updateSeriesFilter();
            checkAchievements();
            closeModal('addModal');
            showSuccess(`Книга "${title}" добавлена в библиотеку!`);
        }

        // Enhanced bulk links functionality
        function toggleBulkLinks() {
            const container = document.getElementById('bulkLinksContainer');
            container.classList.toggle('hidden');
            
            if (!container.classList.contains('hidden')) {
                document.getElementById('bulkLinksText').focus();
            }
        }

        function processBulkLinks() {
            const text = document.getElementById('bulkLinksText').value;
            if (!safeStringTrim(text)) {
                showError('Введите ссылки на главы');
                return;
            }

            const links = text
                .split('\n')
                .map(line => safeStringTrim(line))
                .filter(line => line && (line.startsWith('http') || line.startsWith('https')));

            if (links.length === 0) {
                showError('Не найдено валидных ссылок');
                return;
            }

            // Clear existing chapters and add new ones
            const container = document.getElementById('chaptersContainer');
            container.innerHTML = '';

            links.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">Глава ${index + 1}</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="url" value="${url}" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                `;
                container.appendChild(div);
            });

            clearBulkLinks();
            lucide.createIcons();
            updateChapterButtons();
            showSuccess(`Загружено ${links.length} ссылок на главы!`);
        }

        function clearBulkLinks() {
            const bulkLinksElement = document.getElementById('bulkLinksText');
            const containerElement = document.getElementById('bulkLinksContainer');
            
            if (bulkLinksElement) {
                bulkLinksElement.value = '';
            }
            if (containerElement) {
                containerElement.classList.add('hidden');
            }
        }

        // File upload functionality
        function handleFileUpload(event) {
            const files = Array.from(event.target.files).filter(file => 
                file.type === 'audio/mpeg' || file.type === 'audio/mp3' || file.name.toLowerCase().endsWith('.mp3')
            );

            if (files.length === 0) {
                showError('Выберите MP3 файлы для загрузки');
                return;
            }

            showUploadProgress();
            
            // Clear existing chapters
            document.getElementById('chaptersContainer').innerHTML = '';

            files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

            files.forEach((file, index) => {
                updateProgress(((index + 1) / files.length) * 100);

                const fileUrl = URL.createObjectURL(file);
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                
                const div = document.createElement('div');
                div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">Глава ${index + 1}</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="text" value="${fileName}" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white mb-2 text-sm" placeholder="Название главы">
                    <input type="url" value="${fileUrl}" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                `;
                document.getElementById('chaptersContainer').appendChild(div);
            });

            hideUploadProgress();
            lucide.createIcons();
            updateChapterButtons();
            showSuccess(`Загружено ${files.length} файлов!`);
            event.target.value = '';
        }

        function showUploadProgress() {
            document.getElementById('uploadProgress').classList.remove('hidden');
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').classList.add('hidden');
            updateProgress(0);
        }

        function updateProgress(percentage) {
            const progressBar = document.querySelector('#uploadProgress #progressBar');
            const progressText = document.getElementById('progressText');
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressText) progressText.textContent = Math.round(percentage) + '%';
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('border-blue-400/60', 'bg-blue-500/20');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-400/60', 'bg-blue-500/20');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-400/60', 'bg-blue-500/20');

                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type === 'audio/mpeg' || file.type === 'audio/mp3' || file.name.toLowerCase().endsWith('.mp3')
                );

                if (files.length === 0) {
                    showError('Перетащите MP3 файлы');
                    return;
                }

                const fakeEvent = { target: { files: files, value: '' } };
                handleFileUpload(fakeEvent);
            });
        }

        // Import/Export functionality
        function exportData() {
            try {
                const data = {
                    audiobooks: audiobooks || [],
                    bookmarks: bookmarks || {},
                    achievements: achievements || [],
                    exportDate: new Date().toISOString(),
                    version: "2.0"
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audiobook-library-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setStorageItem('exported_library', 'true');
                showSuccess('Библиотека успешно экспортирована!');
            } catch (error) {
                console.error('Export error:', error);
                showError('Ошибка при экспорте данных');
            }
        }

        function clearAllData() {
            if (!confirm('⚠️ ВНИМАНИЕ!\n\nЭто действие полностью удалит все аудиокниги, закладки и достижения!\n\nВы уверены?')) return;
            if (!confirm('Последнее предупреждение! Все данные будут безвозвратно потеряны.\n\nПродолжить?')) return;
            
            try {
                audiobooks = [];
                bookmarks = {};
                achievements = [];
                currentBook = null;
                currentChapter = 0;
                
                audio.pause();
                audio.src = '';
                isPlaying = false;
                
                // Clear localStorage safely
                const storage = safeLocalStorage();
                if (storage) {
                    storage.clear();
                }
                
                updatePlayer();
                renderLibrary();
                renderQuickRecommendations();
                updateAchievementBadge();
                closeModal('settingsModal');
                
                showSuccess('Все данные успешно очищены!');
            } catch (error) {
                console.error('Error clearing data:', error);
                showError('Ошибка при очистке данных');
            }
        }

        // Open Link Collector
        function openLinkCollector() {
            window.open('https://vteme1.github.io/Link-Collection-Manager', '_blank');
            showSuccess('Сборщик ссылок открыт в новой вкладке!');
        }

        // Enhanced recommendations rendering
        function renderQuickRecommendations() {
            const container = document.getElementById('quickRecommendations');
            const block = document.getElementById('recommendationsBlock');
            
            if (!container || !block) return;
            
            const recommendations = generateQuickRecommendations();
            block.classList.remove('hidden');
            
            if (recommendations.length === 0 || (recommendations.length === 1 && recommendations[0].type === 'getting_started')) {
                container.innerHTML = `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl flex items-center justify-center">
                            <i data-lucide="lightbulb" class="w-8 h-8 text-white/40"></i>
                        </div>
                        <h4 class="text-white font-semibold text-lg mb-2">Добро пожаловать!</h4>
                        <p class="text-white/70 mb-6">Добавьте свои первые аудиокниги, чтобы получить персональные рекомендации</p>
                        <button onclick="openModal('addModal')" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Добавить первую книгу
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            let html = '';
            recommendations.forEach(rec => {
                html += `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-white font-bold text-lg flex items-center">
                                <span class="text-2xl mr-3">${rec.icon}</span>
                                ${rec.title}
                            </h4>
                            ${rec.books.length > 0 ? `
                                <span class="text-white/60 text-sm bg-white/20 px-3 py-1 rounded-full font-medium">
                                    ${rec.books.length} ${rec.books.length === 1 ? 'книга' : rec.books.length < 5 ? 'книги' : 'книг'}
                                </span>
                            ` : ''}
                        </div>
                        <p class="text-white/70 mb-6">${rec.reason}</p>
                        
                        <div class="grid gap-3">
                            ${rec.books.slice(0, 3).map(book => `
                                <div class="flex items-center space-x-4 p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all cursor-pointer hover-lift" onclick="selectBook(${book.id}); scrollToPlayer();">
                                    <div class="flex-shrink-0">
                                        ${book.cover ? 
                                            `<img src="${book.cover}" alt="${book.title}" class="w-12 h-16 rounded-xl object-cover border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                            ''}
                                        <div class="w-12 h-16 rounded-xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/30 flex items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                            <i data-lucide="music" class="w-5 h-5 text-white/60"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h5 class="text-white font-semibold text-sm line-clamp-2 mb-1">${book.title}</h5>
                                        <p class="text-white/60 text-sm line-clamp-1 mb-2">${book.author}</p>
                                        ${book.progress ? `
                                            <div class="flex items-center space-x-2">
                                                <div class="flex-1 bg-white/20 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-blue-400 to-purple-400 h-2 rounded-full" style="width: ${book.progress}%"></div>
                                                </div>
                                                <span class="text-white/50 text-xs font-medium">${book.progress}%</span>
                                            </div>
                                        ` : `
                                            <div class="flex items-center text-white/50 text-xs">
                                                <i data-lucide="headphones" class="w-3 h-3 mr-1"></i>
                                                <span>${book.chapters.length} глав</span>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                            ${rec.books.length > 3 ? `
                                <button onclick="openModal('recommendationsModal')" class="text-center p-3 text-white/60 hover:text-white text-sm hover:bg-white/5 rounded-xl transition-all border border-white/10 hover:border-white/20">
                                    <i data-lucide="more-horizontal" class="w-4 h-4 mr-2"></i>
                                    Посмотреть все ${rec.books.length} книг
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function generateQuickRecommendations() {
            if (audiobooks.length === 0) {
                return [{
                    type: 'getting_started',
                    title: 'Начните свое путешествие',
                    icon: '🌟',
                    books: [],
                    reason: 'Добавьте свои первые аудиокниги и откройте мир захватывающих историй'
                }];
            }
            
            const recommendations = [];
            
            // Continue reading - книги с прогрессом, но не завершенные
            const unfinishedBooks = audiobooks.filter(book => {
                const hasProgress = Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 60;
                });
                
                const lastChapterKey = `${book.id}_${book.chapters.length - 1}`;
                const isCompleted = bookmarks[lastChapterKey] && bookmarks[lastChapterKey] > 300;
                
                return hasProgress && !isCompleted;
            }).map(book => {
                // Calculate progress
                const bookKeys = Object.keys(bookmarks).filter(key => key.startsWith(`${book.id}_`));
                const totalChapters = book.chapters.length;
                const chaptersWithProgress = bookKeys.length;
                const progress = Math.min(100, Math.round((chaptersWithProgress / totalChapters) * 100));
                
                return { ...book, progress };
            }).sort((a, b) => b.progress - a.progress);
            
            if (unfinishedBooks.length > 0) {
                recommendations.push({
                    type: 'continue',
                    title: 'Продолжить чтение',
                    icon: '📖',
                    books: unfinishedBooks,
                    reason: 'Завершите начатые истории'
                });
            }
            
            // New books - книги без прогресса
            const newBooks = audiobooks.filter(book => {
                return !Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 30;
                });
            });
            
            if (newBooks.length > 0 && recommendations.length === 0) {
                recommendations.push({
                    type: 'new',
                    title: 'Новые приключения',
                    icon: '✨',
                    books: newBooks,
                    reason: 'Откройте для себя новые истории'
                });
            }
            
            return recommendations.slice(0, 2);
        }

        function toggleRecommendationsBlock() {
            const block = document.getElementById('recommendationsBlock');
            block.style.transform = 'translateY(-20px)';
            block.style.opacity = '0';
            setTimeout(() => {
                block.classList.add('hidden');
            }, 200);
            setStorageItem('recommendations_hidden', true);
        }

        function scrollToPlayer() {
            const playerSection = document.getElementById('playerSection');
            if (playerSection && !playerSection.classList.contains('hidden')) {
                playerSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Achievement system and other functions remain the same but will be added in next response due to length...
        
        // Initialize everything when DOM is ready
        function initializeApp() {
            try {
                initializeData();
                renderLibrary();
                renderQuickRecommendations();
                updatePlayer();
                setupSearch();
                setupFileUploadHandler();
                setupDragAndDrop();
                setupAudioEventListeners();
                setupVolumeAndSpeedControls();
                
                // Initialize icons
                lucide.createIcons();
                
                console.log('Аудиоплеер успешно инициализирован');
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showError('Ошибка при запуске приложения');
            }
        }

        function setupSearch() {
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value;
                    const clearBtn = document.getElementById('clearSearchBtn');
                    
                    if (searchQuery.trim()) {
                        clearBtn.classList.remove('hidden');
                    } else {
                        clearBtn.classList.add('hidden');
                    }
                    
                    renderLibrary();
                });
            }
        }

        function clearSearch() {
            searchQuery = '';
            searchInput.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            renderLibrary();
        }

        function setupFileUploadHandler() {
            const massUploadElement = document.getElementById('massUpload');
            if (massUploadElement) {
                massUploadElement.addEventListener('change', handleFileUpload);
            }
        }

        function setupAudioEventListeners() {
            // Audio event listeners
            audio.addEventListener('play', () => {
                console.log('Audio play event fired');
                isPlaying = true;
                // Небольшая задержка для корректного обновления
                setTimeout(() => {
                    updatePlayButton();
                }, 50);
            });

            audio.addEventListener('pause', () => {
                console.log('Audio pause event fired');
                isPlaying = false;
                // Небольшая задержка для корректного обновления
                setTimeout(() => {
                    updatePlayButton();
                    saveProgress();
                }, 50);
            });

            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFill.style.width = progress + '%';
                    currentTimeSpan.textContent = formatTime(audio.currentTime);
                    
                    // Auto-save progress every 10 seconds
                    if (Math.floor(audio.currentTime) % 10 === 0) {
                        saveProgress();
                    }
                }
            });

            audio.addEventListener('loadedmetadata', () => {
                durationSpan.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('ended', () => {
                if (currentChapter < currentBook.chapters.length - 1) {
                    nextChapter();
                } else {
                    isPlaying = false;
                    updatePlayButton();
                }
            });

            audio.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                showError('Ошибка загрузки аудио. Проверьте ссылку на файл.');
                isPlaying = false;
                updatePlayButton();
            });

            // Progress bar click
            progressBar.addEventListener('click', (e) => {
                if (!audio.duration) return;
                const rect = progressBar.getBoundingClientRect();
                const percentage = ((e.clientX - rect.left) / rect.width) * 100;
                seekTo(percentage);
            });

            // Chapter selector
            chapterSelect.addEventListener('change', () => {
                currentChapter = parseInt(chapterSelect.value);
                loadChapter();
                updateControls();
            });
        }

        function setupVolumeAndSpeedControls() {
            // Volume slider
            volumeSlider.addEventListener('input', () => {
                const volume = volumeSlider.value;
                audio.volume = volume;
                volumeDisplay.textContent = Math.round(volume * 100) + '%';
            });

            // Speed selector
            speedSelect.addEventListener('change', () => {
                audio.playbackRate = speedSelect.value;
            });
        }

        // Series functionality
        function getAllSeries() {
            const seriesMap = new Map();
            
            if (!audiobooks || !Array.isArray(audiobooks)) return [];
            
            audiobooks.forEach(book => {
                if (book && book.series && typeof book.series === 'string' && safeStringTrim(book.series)) {
                    const seriesName = safeStringTrim(book.series);
                    if (!seriesMap.has(seriesName)) {
                        seriesMap.set(seriesName, {
                            name: seriesName,
                            books: [],
                            author: book.author || 'Неизвестный автор',
                            totalChapters: 0
                        });
                    }
                    
                    const series = seriesMap.get(seriesName);
                    series.books.push(book);
                    series.totalChapters += (book.chapters && Array.isArray(book.chapters)) ? book.chapters.length : 0;
                }
            });
            
            seriesMap.forEach(series => {
                series.books.sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            });
            
            return Array.from(seriesMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        }

        function getNextBookInSeries(book) {
            if (!book?.series || !audiobooks || !Array.isArray(audiobooks)) return null;
            
            const seriesBooks = audiobooks
                .filter(b => b && b.series === book.series)
                .sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            
            const currentIndex = seriesBooks.findIndex(b => b && b.id === book.id);
            return currentIndex >= 0 && currentIndex < seriesBooks.length - 1 ? seriesBooks[currentIndex + 1] : null;
        }

        function getPrevBookInSeries(book) {
            if (!book?.series || !audiobooks || !Array.isArray(audiobooks)) return null;
            
            const seriesBooks = audiobooks
                .filter(b => b && b.series === book.series)
                .sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            
            const currentIndex = seriesBooks.findIndex(b => b && b.id === book.id);
            return currentIndex > 0 ? seriesBooks[currentIndex - 1] : null;
        }

        function goToNextBookInSeries() {
            const nextBook = getNextBookInSeries(currentBook);
            if (nextBook) {
                selectBook(nextBook.id);
                showSuccess(`Переключение на "${nextBook.title}"`);
            }
        }

        function goToPrevBookInSeries() {
            const prevBook = getPrevBookInSeries(currentBook);
            if (prevBook) {
                selectBook(prevBook.id);
                showSuccess(`Переключение на "${prevBook.title}"`);
            }
        }

        function toggleSeriesView() {
            showSeriesView = !showSeriesView;
            const btn = document.getElementById('seriesViewBtn');
            
            if (showSeriesView) {
                btn.classList.add('bg-blue-500/30', 'border-blue-400/50');
                btn.classList.remove('bg-white/10', 'border-white/20');
                renderSeriesView();
            } else {
                btn.classList.remove('bg-blue-500/30', 'border-blue-400/50');
                btn.classList.add('bg-white/10', 'border-white/20');
                renderLibrary();
            }
        }

        function renderSeriesView() {
            const allSeries = getAllSeries();
            
            if (allSeries.length === 0) {
                booksList.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="layers" class="w-12 h-12 text-white/40"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">Нет серий книг</h4>
                        <p class="text-white/50 mb-6">Добавьте серию при создании новой книги</p>
                        <button onclick="openModal('addModal')" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Добавить книгу с серией
                        </button>
                    </div>
                `;
                return;
            }

            let seriesHtml = '';
            
            allSeries.forEach(series => {
                seriesHtml += `
                    <div class="bg-gradient-to-r from-white/5 to-white/10 border border-white/20 rounded-3xl p-6 hover-lift">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h4 class="text-white font-bold text-xl flex items-center mb-2">
                                    <div class="p-2 bg-gradient-to-br from-purple-500/30 to-pink-500/30 rounded-xl mr-3">
                                        <i data-lucide="layers" class="w-6 h-6"></i>
                                    </div>
                                    ${series.name}
                                </h4>
                                <p class="text-white/60">
                                    ${series.author} • ${series.books.length} книг • ${series.totalChapters} глав
                                </p>
                            </div>
                            <button onclick="filterBySeries('${series.name}'); toggleSeriesView();" class="btn-primary px-4 py-2 rounded-xl hover-lift">
                                Открыть серию
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${series.books.slice(0, 6).map(book => `
                                <div class="flex items-center space-x-3 p-3 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 transition-all hover-lift" onclick="selectBook(${book.id}); toggleSeriesView();">
                                    <div class="flex-shrink-0">
                                        ${book.cover ? 
                                            `<img src="${book.cover}" alt="${book.title}" class="w-10 h-14 rounded-lg object-cover border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                            ''}
                                        <div class="w-10 h-14 rounded-lg bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/20 flex items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                            <span class="text-white/60 text-xs font-bold">#${book.seriesOrder || 1}</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-white text-sm font-semibold line-clamp-2 mb-1">
                                            #${book.seriesOrder || 1}. ${book.title}
                                        </p>
                                        <p class="text-white/50 text-xs">${book.chapters.length} глав</p>
                                    </div>
                                </div>
                            `).join('')}
                            ${series.books.length > 6 ? `
                                <div class="flex items-center justify-center p-3 text-white/40 text-sm border border-white/10 rounded-xl">
                                    +${series.books.length - 6} еще...
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            booksList.innerHTML = seriesHtml;
            lucide.createIcons();
        }

        function updateSeriesFilter() {
            // This function can be enhanced later for series filtering
        }

        function filterBySeries(seriesName) {
            // This function can be enhanced later for series filtering
        }

        // Basic edit functionality
        function editBook(bookId) {
            const book = audiobooks.find(b => b.id === bookId);
            if (!book) return;
            
            editingBook = { ...book, chapters: book.chapters.map(ch => ({ ...ch })) };
            
            document.getElementById('editBookTitle').value = book.title || '';
            document.getElementById('editBookAuthor').value = book.author || '';
            document.getElementById('editBookCover').value = book.cover || '';
            document.getElementById('editBookSeries').value = book.series || '';
            document.getElementById('editBookSeriesOrder').value = book.seriesOrder || 1;
            
            renderEditChapters();
            openModal('editModal');
        }

        function renderEditChapters() {
            const container = document.getElementById('editChaptersContainer');
            
            let html = '';
            editingBook.chapters.forEach((chapter, index) => {
                html += `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-4 mb-3" data-chapter-index="${index}">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-white font-medium">Глава ${index + 1}</span>
                            ${editingBook.chapters.length > 1 ? `
                                <button onclick="removeEditChapter(${index})" class="bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 p-1 rounded-lg transition-all">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            ` : ''}
                        </div>
                        <input type="text" placeholder="Название главы" value="${chapter.title || ''}" onchange="updateEditChapter(${index}, 'title', this.value)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-3">
                        <input type="url" placeholder="MP3 ссылка" value="${chapter.url || ''}" onchange="updateEditChapter(${index}, 'url', this.value)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                `;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function addEditChapter() {
            editingBook.chapters.push({
                title: `Глава ${editingBook.chapters.length + 1}`,
                url: ''
            });
            renderEditChapters();
        }

        function removeEditChapter(index) {
            if (editingBook.chapters.length > 1) {
                editingBook.chapters.splice(index, 1);
                renderEditChapters();
            }
        }

        function updateEditChapter(index, field, value) {
            if (editingBook.chapters[index]) {
                editingBook.chapters[index][field] = value;
            }
        }

        function saveEditedBook() {
            if (!safeStringTrim(editingBook.title)) {
                showError('Введите название книги');
                return;
            }

            editingBook.title = safeStringTrim(document.getElementById('editBookTitle').value);
            editingBook.author = safeStringTrim(document.getElementById('editBookAuthor').value) || 'Неизвестный автор';
            editingBook.cover = safeStringTrim(document.getElementById('editBookCover').value) || null;
            editingBook.series = safeStringTrim(document.getElementById('editBookSeries').value) || null;
            editingBook.seriesOrder = parseInt(document.getElementById('editBookSeriesOrder').value) || 1;

            const validChapters = editingBook.chapters.filter(ch => 
                ch && ch.url && safeStringTrim(ch.url)
            );

            if (validChapters.length === 0) {
                showError('Добавьте хотя бы одну главу');
                return;
            }

            editingBook.chapters = validChapters;

            const bookIndex = audiobooks.findIndex(book => book.id === editingBook.id);
            if (bookIndex !== -1) {
                audiobooks[bookIndex] = editingBook;
                
                if (currentBook?.id === editingBook.id) {
                    currentBook = editingBook;
                    if (currentChapter >= editingBook.chapters.length) {
                        currentChapter = 0;
                    }
                    updatePlayer();
                }
                
                saveData();
                renderLibrary();
                closeModal('editModal');
                showSuccess('Книга успешно обновлена!');
            }
        }

        // Basic bookmark and achievement systems
        function renderBookmarks() {
            const container = document.getElementById('bookmarksList');
            
            const allBookmarks = Object.entries(bookmarks)
                .map(([key, time]) => {
                    const [bookId, chapterIndex] = key.split('_');
                    const book = audiobooks.find(b => b.id === parseInt(bookId));
                    if (!book || time <= 0) return null;
                    
                    return {
                        bookId: parseInt(bookId),
                        chapterIndex: parseInt(chapterIndex),
                        time,
                        bookTitle: book.title,
                        bookAuthor: book.author,
                        chapterTitle: book.chapters[parseInt(chapterIndex)]?.title || `Глава ${parseInt(chapterIndex) + 1}`
                    };
                })
                .filter(Boolean)
                .sort((a, b) => b.time - a.time);
            
            if (allBookmarks.length === 0) {
                container.innerHTML = `
                    <div id="emptyBookmarks" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="bookmark-check" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">Нет сохраненных закладок</h4>
                        <p class="text-white/50 max-w-sm mx-auto">Закладки создаются автоматически во время прослушивания или вручную</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            allBookmarks.forEach(bookmark => {
                html += `
                    <div class="bg-white/10 border border-white/20 rounded-2xl p-6 hover:bg-white/15 transition-all hover-lift">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0 mr-4">
                                <h4 class="text-white font-semibold text-lg mb-2 line-clamp-2">
                                    ${bookmark.bookTitle}
                                </h4>
                                <p class="text-white/60 mb-3 line-clamp-1">
                                    ${bookmark.bookAuthor} • ${bookmark.chapterTitle}
                                </p>
                                <div class="flex items-center text-yellow-400 mb-3">
                                    <i data-lucide="bookmark-check" class="w-5 h-5 mr-2"></i>
                                    <span class="font-medium">${formatTime(bookmark.time)}</span>
                                </div>
                            </div>
                            
                            <button onclick="jumpToBookmark(${bookmark.bookId}, ${bookmark.chapterIndex}, ${bookmark.time})" class="btn-primary px-4 py-2 rounded-xl hover-lift whitespace-nowrap">
                                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                                Перейти
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button onclick="clearAllBookmarks()" class="w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-400/40 rounded-2xl py-4 text-red-200 hover:from-red-500/30 hover:to-orange-500/30 transition-all hover-lift">
                    <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                    Очистить все закладки
                </button>
            `;
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function jumpToBookmark(bookId, chapterIndex, time) {
            if (!audiobooks || !Array.isArray(audiobooks)) return;
            
            const book = audiobooks.find(b => b && b.id === bookId);
            if (!book) {
                showError('Книга не найдена');
                return;
            }
            
            selectBook(bookId);
            currentChapter = Math.max(0, chapterIndex);
            
            setTimeout(() => {
                try {
                    if (audio.duration && time >= 0 && time <= audio.duration) {
                        audio.currentTime = time;
                    }
                    updatePlayer();
                } catch (error) {
                    console.error('Error jumping to bookmark:', error);
                }
            }, 500);
            
            closeModal('bookmarksModal');
            showSuccess(`Переход к закладке в "${book.title}"`);
        }

        function clearAllBookmarks() {
            if (confirm('Очистить все сохраненные закладки?')) {
                bookmarks = {};
                saveData();
                renderBookmarks();
                showSuccess('Все закладки очищены!');
            }
        }

        // Basic achievement and recommendation systems
        function renderAchievements() {
            const container = document.getElementById('unlockedAchievements');
            if (container) {
                container.innerHTML = `
                    <div id="emptyAchievements" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="trophy" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">Достижений пока нет</h4>
                        <p class="text-white/50 max-w-md mx-auto">Слушайте книги и исследуйте функции плеера, чтобы разблокировать награды!</p>
                    </div>
                `;
            }
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendationsList');
            if (container) {
                container.innerHTML = `
                    <div id="emptyRecommendations" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="lightbulb" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">Пока нет рекомендаций</h4>
                        <p class="text-white/50 max-w-md mx-auto">Послушайте несколько книг, чтобы получить персональные рекомендации на основе ваших предпочтений!</p>
                    </div>
                `;
            }
        }

        function checkAchievements() {
            // Basic achievement check - can be expanded
        }

        function updateAchievementBadge() {
            // Basic badge update - can be expanded
        }

        function hideAchievementNotification() {
            document.getElementById('achievementNotification').classList.add('hidden');
        }

        // Setup import handler
        function setupImportHandler() {
            const importFileElement = document.getElementById('importFile');
            if (importFileElement) {
                importFileElement.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.audiobooks || !Array.isArray(data.audiobooks)) {
                                throw new Error('Неверный формат файла');
                            }

                            const importChoice = confirm(
                                `Найдено ${data.audiobooks.length} книг.\n\n` +
                                'ОК - Заменить текущую библиотеку\n' +
                                'Отмена - Добавить к существующей библиотеке'
                            );

                            if (importChoice) {
                                audiobooks = data.audiobooks;
                                if (data.bookmarks) bookmarks = data.bookmarks;
                                showSuccess(`Библиотека заменена! Импортировано ${data.audiobooks.length} книг.`);
                            } else {
                                const existingIds = new Set(audiobooks.map(book => book.id));
                                const newBooks = data.audiobooks.filter(book => !existingIds.has(book.id));
                                
                                if (newBooks.length === 0) {
                                    showError('Все книги уже есть в библиотеке!');
                                    return;
                                }

                                audiobooks.push(...newBooks);
                                if (data.bookmarks) {
                                    Object.assign(bookmarks, data.bookmarks);
                                }
                                showSuccess(`Добавлено ${newBooks.length} новых книг!`);
                            }

                            saveData();
                            renderLibrary();
                            renderQuickRecommendations();
                            
                            if (currentBook && !audiobooks.some(book => book.id === currentBook.id)) {
                                currentBook = null;
                                updatePlayer();
                            }

                        } catch (error) {
                            console.error('Import error:', error);
                            showError('Ошибка импорта! Проверьте формат файла.');
                        }
                    };
                    
                    reader.readAsText(file);
                    e.target.value = '';
                });
            }
        }

        // Wait for DOM to be ready, then initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

    </script>
</body>
</html>
