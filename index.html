<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ–ø–ª–µ–µ—Ä –¥–ª—è –∫–Ω–∏–≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Improved select dropdown styling */
        select option {
            background-color: rgba(15, 23, 42, 0.95) !important;
            color: white !important;
            padding: 12px 16px !important;
            border-radius: 8px !important;
        }
        
        select option:hover,
        select option:focus,
        select option:checked {
            background-color: rgba(59, 130, 246, 0.8) !important;
            color: white !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Smooth animations */
        * {
            transition: all 0.2s ease;
        }

        /* Focus improvements */
        button:focus,
        input:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }

        /* Hover effects */
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Progress bar improvements */
        .progress-bar {
            position: relative;
            cursor: pointer;
        }

        .progress-bar:hover .progress-thumb {
            opacity: 1;
            transform: scale(1.2);
        }

        .progress-thumb {
            position: absolute;
            top: 50%;
            right: 0;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transform: translateY(-50%) scale(0);
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Button improvements */
        .btn-primary {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(147, 51, 234, 0.8));
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(147, 51, 234, 1));
            border-color: rgba(59, 130, 246, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Card hover effects */
        .book-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-padding {
                padding: 1rem;
            }
            
            .mobile-text {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-2 sm:p-6">
    <div class="max-w-sm sm:max-w-2xl lg:max-w-4xl xl:max-w-6xl mx-auto space-y-4 sm:space-y-6">
        
        <!-- Header -->
        <header class="glass-effect bg-white/10 rounded-3xl p-4 sm:p-6 border border-white/20 hover-lift">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl border border-white/20">
                        <i data-lucide="headphones" class="w-8 h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-white">–ê—É–¥–∏–æ–ø–ª–µ–µ—Ä</h1>
                        <p class="text-white/60 text-sm">–í–∞—à–∞ –ª–∏—á–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button onclick="openModal('recommendationsModal')" class="btn-secondary p-3 rounded-xl hover-lift relative" title="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-white"></i>
                        <div id="recommendationsBadge" class="absolute -top-1 -right-1 bg-blue-400 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden">
                            <span class="text-xs">!</span>
                        </div>
                    </button>
                    
                    <button onclick="openModal('achievementsModal')" class="btn-secondary p-3 rounded-xl hover-lift relative" title="–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è">
                        <i data-lucide="trophy" class="w-5 h-5 text-white"></i>
                        <div id="achievementsBadge" class="absolute -top-1 -right-1 bg-yellow-400 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold hidden"></div>
                    </button>
                    
                    <button onclick="openModal('bookmarksModal')" class="btn-secondary p-3 rounded-xl hover-lift" title="–ó–∞–∫–ª–∞–¥–∫–∏">
                        <i data-lucide="bookmark-check" class="w-5 h-5 text-white"></i>
                    </button>
                    
                    <button onclick="openModal('addModal')" class="btn-primary p-3 rounded-xl hover-lift" title="–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É">
                        <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                    </button>
                    
                    <button onclick="openModal('settingsModal')" class="btn-secondary p-3 rounded-xl hover-lift" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
            </div>

            <!-- Current Book Player -->
            <div id="playerSection" class="hidden">
                <div class="bg-gradient-to-r from-white/5 to-white/10 rounded-2xl p-6 border border-white/10">
                    <div class="flex items-start space-x-6 mb-6">
                        <div class="flex-shrink-0">
                            <img id="bookCover" class="w-24 h-32 sm:w-32 sm:h-40 rounded-2xl object-cover shadow-2xl border border-white/20 hidden">
                            <div id="defaultCover" class="w-24 h-32 sm:w-32 sm:h-40 rounded-2xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/20 flex items-center justify-center">
                                <i data-lucide="music" class="w-12 h-12 text-white/60"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h2 id="bookTitle" class="text-xl sm:text-2xl font-bold text-white mb-2 line-clamp-2"></h2>
                            <p id="bookAuthor" class="text-white/70 text-base sm:text-lg mb-4"></p>
                            
                            <!-- Chapter selector with bookmark button -->
                            <div class="flex items-center space-x-3 mb-4">
                                <select id="chapterSelect" class="flex-1 bg-white/20 border border-white/30 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                </select>
                                <button onclick="createBookmark()" class="btn-secondary p-3 rounded-xl hover-lift" title="–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–ª–∞–¥–∫—É">
                                    <i data-lucide="bookmark-plus" class="w-5 h-5 text-yellow-300"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Series Navigation -->
                    <div id="seriesNavigation" class="hidden mb-6">
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between">
                                <button id="prevBookBtn" onclick="goToPrevBookInSeries()" class="btn-secondary px-4 py-2 rounded-xl disabled:opacity-50 hover-lift flex items-center space-x-2">
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                    <span class="hidden sm:inline">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
                                </button>
                                
                                <div class="text-center px-4">
                                    <div class="text-white/60 text-sm">–°–µ—Ä–∏—è</div>
                                    <div id="currentSeriesName" class="text-white font-medium"></div>
                                </div>
                                
                                <button id="nextBookBtn" onclick="goToNextBookInSeries()" class="btn-secondary px-4 py-2 rounded-xl disabled:opacity-50 hover-lift flex items-center space-x-2">
                                    <span class="hidden sm:inline">–°–ª–µ–¥—É—é—â–∞—è</span>
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Progress bar -->
                    <div class="mb-6">
                        <div id="progressBar" class="progress-bar w-full bg-white/20 rounded-full h-3 cursor-pointer hover-lift">
                            <div id="progressFill" class="bg-gradient-to-r from-blue-400 to-purple-400 h-3 rounded-full relative" style="width: 0%">
                                <div class="progress-thumb"></div>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm text-white/80 mt-3">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center items-center space-x-4 mb-6">
                        <button onclick="prevChapter()" id="prevBtn" class="btn-secondary p-3 rounded-xl disabled:opacity-50 hover-lift">
                            <i data-lucide="skip-back" class="w-6 h-6 text-white"></i>
                        </button>

                        <button onclick="skipTime(-10)" class="btn-secondary p-2 rounded-xl hover-lift">
                            <span class="text-white text-sm font-bold">-10</span>
                        </button>

                        <button onclick="togglePlay()" id="playBtn" class="btn-primary p-4 rounded-2xl hover-lift shadow-lg">
                            <i data-lucide="play" class="w-8 h-8 text-white"></i>
                        </button>

                        <button onclick="skipTime(10)" class="btn-secondary p-2 rounded-xl hover-lift">
                            <span class="text-white text-sm font-bold">+10</span>
                        </button>

                        <button onclick="nextChapter()" id="nextBtn" class="btn-secondary p-3 rounded-xl disabled:opacity-50 hover-lift">
                            <i data-lucide="skip-forward" class="w-6 h-6 text-white"></i>
                        </button>
                    </div>

                    <!-- Volume and Speed Controls -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="volume-2" class="w-5 h-5 text-white"></i>
                                    <span class="text-white text-sm font-medium">–ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
                                </div>
                                <span id="volumeDisplay" class="text-white/70 text-sm font-mono">100%</span>
                            </div>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-full">
                        </div>
                        
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="gauge" class="w-5 h-5 text-white"></i>
                                    <span class="text-white text-sm font-medium">–°–∫–æ—Ä–æ—Å—Ç—å</span>
                                </div>
                            </div>
                            <select id="speedSelect" class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="text-center py-12">
                <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-3xl flex items-center justify-center border border-white/10">
                    <i data-lucide="music" class="w-12 h-12 text-white/40"></i>
                </div>
                <h3 class="text-xl text-white/70 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ–∫–Ω–∏–≥—É</h3>
                <p class="text-white/50">–∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –≤ —Å–≤–æ—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É</p>
            </div>
        </header>

        <!-- Recommendations Block -->
        <section id="recommendationsBlock" class="glass-effect bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-3xl p-4 sm:p-6 border border-blue-400/20 hover-lift">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-xl mr-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-blue-300"></i>
                    </div>
                    <span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å</span>
                </h2>
                <button onclick="toggleRecommendationsBlock()" class="btn-secondary p-2 rounded-lg hover-lift" title="–°–∫—Ä—ã—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="quickRecommendations" class="grid gap-4">
                <!-- Recommendations content will be inserted here -->
            </div>
        </section>

        <!-- Library -->
        <section class="glass-effect bg-white/10 rounded-3xl p-4 sm:p-6 border border-white/20 hover-lift">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-green-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="library" class="w-5 h-5"></i>
                    </div>
                    <span id="libraryTitle">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ (0)</span>
                </h2>
                
                <div class="flex items-center space-x-2">
                    <button onclick="toggleSeriesView()" id="seriesViewBtn" class="btn-secondary p-2 rounded-lg hover-lift" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ä–∏–∏">
                        <i data-lucide="layers" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div id="searchFilters" class="space-y-4 mb-6">
                <!-- Search -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-white/60"></i>
                    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫–Ω–∏–≥, –∞–≤—Ç–æ—Ä–æ–≤ –∏ —Å–µ—Ä–∏–π..." class="w-full bg-white/10 border border-white/20 rounded-2xl pl-12 pr-12 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button onclick="clearSearch()" id="clearSearchBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white/60 hover:text-white transition-colors hidden">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Series Filter -->
                <div id="seriesFilter" class="flex space-x-2 overflow-x-auto pb-2 hidden">
                    <button onclick="filterBySeries(null)" class="btn-primary px-4 py-2 rounded-xl text-sm whitespace-nowrap" id="allBooksBtn">
                        –í—Å–µ –∫–Ω–∏–≥–∏
                    </button>
                </div>
            </div>
            
            <!-- Books list -->
            <div id="booksList" class="grid gap-4">
                <div id="emptyLibrary" class="text-center py-12">
                    <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="book-open" class="w-10 h-10 text-white/40"></i>
                    </div>
                    <h3 class="text-xl text-white/70 mb-4">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞</h3>
                    
                    <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-400/20 rounded-2xl p-6 max-w-md mx-auto">
                        <h4 class="text-white font-semibold mb-4 flex items-center justify-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                            –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥–∏
                        </h4>
                        <div class="text-white/80 text-sm space-y-3 text-left">
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">1</span>
                                </div>
                                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "+" –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">2</span>
                                </div>
                                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ</p>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="w-6 h-6 bg-blue-500/30 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span class="text-xs font-bold">3</span>
                                </div>
                                <p>–î–æ–±–∞–≤—å—Ç–µ MP3 —Ñ–∞–π–ª—ã –∏–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–ª–∞–≤—ã</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Book Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-green-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
                </h3>
                <button onclick="closeModal('addModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="newBookTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="text" id="newBookAuthor" placeholder="–ê–≤—Ç–æ—Ä" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                
                <input type="url" id="newBookCover" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <input type="text" id="newBookSeries" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <input type="number" id="newBookSeriesOrder" placeholder="–ù–æ–º–µ—Ä –≤ —Å–µ—Ä–∏–∏" min="1" value="1" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center">
                    </div>
                </div>
                
                <div>
                    <label class="text-white font-semibold text-lg mb-4 block">–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—ã:</label>
                    
                    <!-- Upload Options -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="relative">
                            <input
                                type="file"
                                accept=".mp3,audio/mpeg,audio/mp3"
                                multiple
                                id="massUpload"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                            />
                            <label
                                for="massUpload"
                                class="btn-primary w-full rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2 cursor-pointer"
                            >
                                <i data-lucide="upload" class="w-5 h-5"></i>
                                <span>MP3 —Ñ–∞–π–ª—ã</span>
                            </label>
                        </div>

                        <div
                            id="dropZone"
                            class="btn-secondary border-2 border-dashed border-white/30 rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2"
                        >
                            <i data-lucide="move-3d" class="w-5 h-5"></i>
                            <span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å</span>
                        </div>

                        <button
                            onclick="toggleBulkLinks()"
                            class="btn-secondary rounded-2xl px-4 py-4 text-white hover-lift flex items-center justify-center space-x-2"
                        >
                            <i data-lucide="link" class="w-5 h-5"></i>
                            <span>–ò–∑ —Å—Å—ã–ª–æ–∫</span>
                        </button>
                    </div>

                    <!-- Bulk Links Container -->
                    <div id="bulkLinksContainer" class="mb-6 hidden">
                        <div class="bg-white/5 border border-white/20 rounded-2xl p-4">
                            <textarea
                                id="bulkLinksText"
                                placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–ª–∞–≤—ã (–∫–∞–∂–¥–∞—è —Å—Å—ã–ª–∫–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
https://example.com/chapter1.mp3
https://example.com/chapter2.mp3
..."
                                class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm resize-none"
                                rows="6"
                            ></textarea>
                            <div class="flex space-x-3 mt-4">
                                <button
                                    onclick="processBulkLinks()"
                                    class="btn-primary flex-1 rounded-xl px-4 py-3 text-white hover-lift flex items-center justify-center space-x-2"
                                >
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Å—ã–ª–∫–∏</span>
                                </button>
                                <button
                                    onclick="clearBulkLinks()"
                                    class="btn-secondary px-4 py-3 rounded-xl text-white hover-lift"
                                >
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="bg-white/10 border border-white/20 rounded-2xl p-4 mb-6 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-white font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</span>
                            <span id="progressText" class="text-white font-mono">0%</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3">
                            <div
                                id="progressBar"
                                class="bg-gradient-to-r from-green-400 to-blue-400 h-3 rounded-full transition-all duration-300"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>

                    <!-- Info Card -->
                    <div class="bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-400/20 rounded-2xl p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="p-2 bg-purple-500/20 rounded-lg">
                                <i data-lucide="info" class="w-5 h-5 text-purple-300"></i>
                            </div>
                            <div>
                                <h4 class="text-white font-medium mb-2">–°–ø–æ—Å–æ–±—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–ª–∞–≤</h4>
                                <ul class="text-purple-200 text-sm space-y-1">
                                    <li>‚Ä¢ <strong>MP3 —Ñ–∞–π–ª—ã:</strong> –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</li>
                                    <li>‚Ä¢ <strong>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ:</strong> –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ –æ–±–ª–∞—Å—Ç—å</li>
                                    <li>‚Ä¢ <strong>–°—Å—ã–ª–∫–∏:</strong> –í—Å—Ç–∞–≤—å—Ç–µ URL –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã</li>
                                    <li>‚Ä¢ <strong>–í—Ä—É—á–Ω—É—é:</strong> –î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏ –ø–æ –æ–¥–Ω–æ–π</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Chapter Addition -->
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-white font-medium">–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≥–ª–∞–≤—ã –≤—Ä—É—á–Ω—É—é:</span>
                        </div>
                        
                        <div id="chaptersContainer">
                            <div class="chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-white font-medium">–ì–ª–∞–≤–∞ 1</span>
                                    <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg opacity-0 pointer-events-none">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <input type="url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Ñ–∞–π–ª" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                        </div>
                        
                        <button onclick="addChapter()" class="btn-secondary w-full border-2 border-dashed border-white/30 rounded-2xl py-4 text-white hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É
                        </button>
                    </div>
                </div>

                <div class="flex space-x-4 pt-6">
                    <button onclick="closeModal('addModal')" class="btn-secondary flex-1 rounded-2xl py-4 text-white hover-lift">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="addBook()" class="btn-primary flex-1 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="check" class="w-5 h-5 mr-2"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-md border border-white/30">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-gray-500/30 to-blue-500/30 rounded-xl mr-3">
                        <i data-lucide="settings" class="w-6 h-6"></i>
                    </div>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </h3>
                <button onclick="closeModal('settingsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-4">
                <button onclick="exportData()" class="w-full btn-primary rounded-2xl px-6 py-4 text-white hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>–≠–∫—Å–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</span>
                </button>

                <div class="relative">
                    <input type="file" id="importFile" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <div class="w-full btn-secondary rounded-2xl px-6 py-4 text-white hover-lift flex items-center justify-center space-x-3 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        <span>–ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</span>
                    </div>
                </div>

                <button onclick="openLinkCollector()" class="w-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-400/30 rounded-2xl px-6 py-4 text-white hover:from-purple-500/30 hover:to-pink-500/30 transition-all hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="link" class="w-5 h-5"></i>
                    <span>–°–±–æ—Ä—â–∏–∫ —Å—Å—ã–ª–æ–∫</span>
                </button>

                <button onclick="clearAllData()" class="w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-400/40 rounded-2xl px-6 py-4 text-red-200 hover:from-red-500/30 hover:to-orange-500/30 transition-all hover-lift flex items-center justify-center space-x-3">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <div class="p-2 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-xl mr-3">
                        <i data-lucide="edit-3" class="w-6 h-6"></i>
                    </div>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É
                </h3>
                <button onclick="closeModal('editModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="text" id="editBookTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="text" id="editBookAuthor" placeholder="–ê–≤—Ç–æ—Ä" class="bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                
                <input type="url" id="editBookCover" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <input type="text" id="editBookSeries" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <input type="number" id="editBookSeriesOrder" placeholder="‚Ññ" min="1" value="1" class="w-full bg-white/10 border border-white/20 rounded-2xl px-4 py-4 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 text-center">
                    </div>
                </div>

                <div>
                    <label class="text-white font-semibold text-lg mb-4 block">–ì–ª–∞–≤—ã:</label>
                    <div id="editChaptersContainer"></div>
                    <button onclick="addEditChapter()" class="w-full btn-secondary border-2 border-dashed border-white/30 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É
                    </button>
                </div>

                <div class="flex space-x-4 pt-6">
                    <button onclick="closeModal('editModal')" class="btn-secondary flex-1 rounded-2xl py-4 text-white hover-lift">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="saveEditedBook()" class="btn-primary flex-1 rounded-2xl py-4 text-white hover-lift">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Modal -->
    <div id="recommendationsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-4xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-blue-300"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                </div>
                <button onclick="closeModal('recommendationsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Statistics -->
            <div class="bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-400/20 rounded-2xl p-6 mb-6">
                <h4 class="text-white font-semibold mb-4 flex items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-3"></i>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏—è
                </h4>
                <div id="statsGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div id="totalBooksCount" class="text-3xl font-bold text-white mb-1">0</div>
                        <div class="text-white/70 text-sm">–í—Å–µ–≥–æ –∫–Ω–∏–≥</div>
                    </div>
                    <div class="text-center">
                        <div id="completedBooksCount" class="text-3xl font-bold text-green-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">–ü—Ä–æ—Å–ª—É—à–∞–Ω–æ</div>
                    </div>
                    <div class="text-center">
                        <div id="inProgressBooksCount" class="text-3xl font-bold text-yellow-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                    </div>
                    <div class="text-center">
                        <div id="unlistenedBooksCount" class="text-3xl font-bold text-blue-400 mb-1">0</div>
                        <div class="text-white/70 text-sm">–ù–µ –Ω–∞—á–∞—Ç–æ</div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <div class="flex justify-between text-sm text-white/80 mb-3">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span>
                        <span id="completionRate">0%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-3">
                        <div id="completionBar" class="bg-gradient-to-r from-green-400 to-blue-400 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="recommendationsList" class="space-y-6">
                <div id="emptyRecommendations" class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="lightbulb" class="w-12 h-12 text-white/30"></i>
                    </div>
                    <h4 class="text-xl text-white/60 mb-4">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</h4>
                    <p class="text-white/50 max-w-md mx-auto">–ü–æ—Å–ª—É—à–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievementsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-4xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-yellow-500/30 to-orange-500/30 rounded-2xl">
                        <i data-lucide="trophy" class="w-6 h-6 text-yellow-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                </div>
                <button onclick="closeModal('achievementsModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-400/20 rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-white font-semibold">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h4>
                    <span id="achievementStats" class="text-white font-bold text-lg">0/108</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-4">
                    <div id="achievementProgress" class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="text-center mt-3">
                    <span id="achievementPercentage" class="text-yellow-400 font-bold text-2xl">0%</span>
                    <span class="text-white/60 text-sm ml-2">–∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h4 class="text-white font-semibold text-lg mb-4 flex items-center">
                        <i data-lucide="star" class="w-6 h-6 mr-3 text-yellow-400"></i>
                        –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </h4>
                    
                    <div id="unlockedAchievements" class="space-y-4">
                        <div id="emptyAchievements" class="text-center py-16">
                            <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-3xl flex items-center justify-center">
                                <i data-lucide="trophy" class="w-12 h-12 text-white/30"></i>
                            </div>
                            <h4 class="text-xl text-white/60 mb-4">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h4>
                            <p class="text-white/50 max-w-md mx-auto">–°–ª—É—à–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –∏ –∏—Å—Å–ª–µ–¥—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã!</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-white font-semibold text-lg mb-4 flex items-center">
                        <i data-lucide="lock" class="w-6 h-6 mr-3 text-white/40"></i>
                        –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </h4>
                    
                    <div id="lockedAchievements" class="grid gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookmarks Modal -->
    <div id="bookmarksModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="glass-effect bg-white/20 rounded-3xl p-6 w-full max-w-2xl border border-white/30 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="p-3 bg-gradient-to-br from-blue-500/30 to-purple-500/30 rounded-2xl">
                        <i data-lucide="bookmark-check" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white">–ó–∞–∫–ª–∞–¥–∫–∏</h3>
                </div>
                <button onclick="closeModal('bookmarksModal')" class="btn-secondary p-2 rounded-xl hover-lift">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="bookmarksList" class="space-y-4">
                <div id="emptyBookmarks" class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                        <i data-lucide="bookmark-check" class="w-12 h-12 text-white/30"></i>
                    </div>
                    <h4 class="text-xl text-white/60 mb-4">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–ª–∞–¥–æ–∫</h4>
                    <p class="text-white/50 max-w-sm mx-auto">–ó–∞–∫–ª–∞–¥–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏–ª–∏ –≤—Ä—É—á–Ω—É—é</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievement Notification -->
    <div id="achievementNotification" class="fixed top-6 right-6 z-[60] hidden">
        <div class="bg-gradient-to-r from-yellow-400/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-4 border border-yellow-400/40 max-w-sm shadow-2xl hover-lift">
            <div class="flex items-center space-x-3">
                <div id="achievementIcon" class="text-4xl">üèÜ</div>
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <i data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i>
                        <span class="text-white font-bold">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!</span>
                    </div>
                    <h4 id="achievementName" class="text-white font-semibold mb-1"></h4>
                    <p id="achievementDescription" class="text-white/80 text-sm mb-1"></p>
                    <span id="achievementRarity" class="text-white/60 text-xs bg-white/20 px-2 py-1 rounded-full"></span>
                </div>
                <button onclick="hideAchievementNotification()" class="btn-secondary p-1 rounded-lg">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global state
        let audiobooks = [];
        let currentBook = null;
        let currentChapter = 0;
        let isPlaying = false;
        let bookmarks = {};
        let achievements = [];
        let editingBook = null;
        let showSeriesView = false;
        let selectedSeries = null;
        let searchQuery = '';
        
        // Safe localStorage wrapper
        function safeLocalStorage() {
            try {
                return typeof localStorage !== 'undefined' ? localStorage : null;
            } catch (e) {
                console.warn('localStorage not available:', e);
                return null;
            }
        }
        
        // Safe storage functions
        function getStorageItem(key, defaultValue = null) {
            const storage = safeLocalStorage();
            if (!storage) return defaultValue;
            
            try {
                const item = storage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.warn('Error reading from storage:', e);
                return defaultValue;
            }
        }
        
        function setStorageItem(key, value) {
            const storage = safeLocalStorage();
            if (!storage) return false;
            
            try {
                storage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.warn('Error writing to storage:', e);
                return false;
            }
        }

        // Initialize data from localStorage
        function initializeData() {
            audiobooks = getStorageItem('audiobooks', []);
            bookmarks = getStorageItem('bookmarks', {});
            achievements = getStorageItem('achievements', []);
        }
        
        const audio = document.getElementById('audioPlayer');
        
        // DOM elements
        const playerSection = document.getElementById('playerSection');
        const emptyState = document.getElementById('emptyState');
        const bookTitle = document.getElementById('bookTitle');
        const bookAuthor = document.getElementById('bookAuthor');
        const bookCover = document.getElementById('bookCover');
        const defaultCover = document.getElementById('defaultCover');
        const chapterSelect = document.getElementById('chapterSelect');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const currentTimeSpan = document.getElementById('currentTime');
        const durationSpan = document.getElementById('duration');
        const playBtn = document.getElementById('playBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const speedSelect = document.getElementById('speedSelect');
        const searchInput = document.getElementById('searchInput');
        const booksList = document.getElementById('booksList');
        const libraryTitle = document.getElementById('libraryTitle');
        const emptyLibrary = document.getElementById('emptyLibrary');

        // Utility functions
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function saveData() {
            setStorageItem('audiobooks', audiobooks);
            setStorageItem('bookmarks', bookmarks);
            setStorageItem('achievements', achievements);
        }

        function safeStringTrim(value) {
            if (value === null || value === undefined) return '';
            if (typeof value !== 'string') {
                console.warn('Attempting to trim non-string value:', typeof value, value);
                return String(value).trim();
            }
            return value.trim();
        }

        function showSuccess(message) {
            // Create a modern toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-6 right-6 bg-gradient-to-r from-green-400/20 to-blue-500/20 backdrop-blur-lg rounded-2xl p-4 border border-green-400/40 shadow-2xl z-50 hover-lift';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-green-500/20 rounded-xl">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            // Create a modern error notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-6 right-6 bg-gradient-to-r from-red-400/20 to-orange-500/20 backdrop-blur-lg rounded-2xl p-4 border border-red-400/40 shadow-2xl z-50 hover-lift';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-red-500/20 rounded-xl">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
                    </div>
                    <div>
                        <p class="text-white font-medium">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 4000);
            }, 4000);
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }
            modal.classList.remove('hidden');
            
            // Load content when opening modals
            switch(modalId) {
                case 'bookmarksModal':
                    renderBookmarks();
                    break;
                case 'recommendationsModal':
                    renderRecommendations();
                    break;
                case 'achievementsModal':
                    renderAchievements();
                    break;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'addModal') {
                resetAddForm();
            }
        }

        // Audio functions
        function selectBook(bookId) {
            if (!audiobooks || !Array.isArray(audiobooks)) return;
            
            currentBook = audiobooks.find(book => book && book.id === bookId);
            if (!currentBook) {
                console.error('Book not found:', bookId);
                return;
            }
            
            currentChapter = 0;
            updatePlayer();
            loadChapter();
        }

        function updatePlayer() {
            if (!currentBook || !playerSection || !emptyState) {
                if (playerSection) playerSection.classList.add('hidden');
                if (emptyState) emptyState.classList.remove('hidden');
                const seriesNav = document.getElementById('seriesNavigation');
                if (seriesNav) seriesNav.classList.add('hidden');
                return;
            }

            playerSection.classList.remove('hidden');
            emptyState.classList.add('hidden');

            bookTitle.textContent = currentBook.title;
            bookAuthor.textContent = currentBook.author;
            
            if (currentBook.cover) {
                bookCover.src = currentBook.cover;
                bookCover.classList.remove('hidden');
                defaultCover.classList.add('hidden');
            } else {
                bookCover.classList.add('hidden');
                defaultCover.classList.remove('hidden');
            }

            // Update chapter select
            chapterSelect.innerHTML = '';
            currentBook.chapters.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${chapter.title}`;
                chapterSelect.appendChild(option);
            });
            chapterSelect.value = currentChapter;

            // Update series navigation
            updateSeriesNavigation();

            updateControls();
        }

        function updateSeriesNavigation() {
            const seriesNav = document.getElementById('seriesNavigation');
            const seriesName = document.getElementById('currentSeriesName');
            const prevBtn = document.getElementById('prevBookBtn');
            const nextBtn = document.getElementById('nextBookBtn');

            if (currentBook && currentBook.series) {
                seriesNav.classList.remove('hidden');
                seriesName.textContent = `${currentBook.series} #${currentBook.seriesOrder || 1}`;

                const prevBook = getPrevBookInSeries(currentBook);
                const nextBook = getNextBookInSeries(currentBook);

                prevBtn.disabled = !prevBook;
                nextBtn.disabled = !nextBook;
            } else {
                seriesNav.classList.add('hidden');
            }
        }

        function updateControls() {
            document.getElementById('prevBtn').disabled = currentChapter === 0;
            document.getElementById('nextBtn').disabled = currentChapter === currentBook.chapters.length - 1;
        }

        function loadChapter() {
            if (!currentBook || !currentBook.chapters || !currentBook.chapters[currentChapter]) {
                console.error('Cannot load chapter: invalid book or chapter');
                return;
            }
            
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                if (!audio.paused) {
                    audio.pause();
                }
                isPlaying = false;
                
                const chapter = currentBook.chapters[currentChapter];
                if (!chapter || !chapter.url) {
                    console.error('Invalid chapter data');
                    showError('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–ª–∞–≤—ã');
                    return;
                }
                
                console.log('Loading chapter:', chapter.title, chapter.url);
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                audio.src = '';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º
                audio.src = chapter.url;
                audio.load();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                setTimeout(() => {
                    updatePlayButton();
                }, 100);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                const savedTime = getSavedTime();
                if (savedTime > 0) {
                    audio.addEventListener('loadedmetadata', () => {
                        if (audio.duration && savedTime < audio.duration) {
                            audio.currentTime = savedTime;
                            console.log('Restored position:', formatTime(savedTime));
                        }
                    }, { once: true });
                }
                
            } catch (error) {
                console.error('Error loading chapter:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã');
            }
        }

        function togglePlay() {
            if (!currentBook) {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                return;
            }
            
            if (!audio.src || audio.src === '') {
                showError('–ù–µ —É–¥–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª');
                return;
            }
            
            console.log('Toggle play clicked. Current state:', isPlaying);
            
            if (isPlaying) {
                audio.pause();
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ 'pause'
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const playButton = document.getElementById('playBtn');
                playButton.innerHTML = '<i data-lucide="loader" class="w-6 h-6 sm:w-8 sm:h-8 text-white animate-spin"></i>';
                lucide.createIcons();
                
                audio.play().then(() => {
                    console.log('Audio started successfully');
                    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ 'play'
                }).catch(error => {
                    console.error('Playback error:', error);
                    isPlaying = false;
                    updatePlayButton();
                    showError('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª.');
                });
            }
        }

        function updatePlayButton() {
            const playButton = document.getElementById('playBtn');
            if (!playButton) {
                console.error('Play button not found');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω—É–∂–Ω—É—é –∏–∫–æ–Ω–∫—É
            const iconName = isPlaying ? 'pause' : 'play';
            
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–æ–ø–∫–∏
            playButton.innerHTML = `<i data-lucide="${iconName}" class="w-6 h-6 sm:w-8 sm:h-8 text-white"></i>`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ Lucide
            lucide.createIcons();
            
            console.log('Play button updated. Is playing:', isPlaying, 'Icon:', iconName);
        }

        function skipTime(seconds) {
            if (!audio.src) return;
            audio.currentTime = Math.max(0, Math.min(audio.currentTime + seconds, audio.duration || 0));
        }

        function prevChapter() {
            if (currentChapter > 0) {
                currentChapter--;
                chapterSelect.value = currentChapter;
                loadChapter();
                updateControls();
            }
        }

        function nextChapter() {
            if (currentChapter < currentBook.chapters.length - 1) {
                currentChapter++;
                chapterSelect.value = currentChapter;
                loadChapter();
                updateControls();
            }
        }

        function seekTo(percentage) {
            if (!audio.duration) return;
            audio.currentTime = (percentage / 100) * audio.duration;
        }

        // Bookmark functions
        function getSavedTime() {
            if (!currentBook) return 0;
            const key = `${currentBook.id}_${currentChapter}`;
            return bookmarks[key] || 0;
        }

        function saveProgress() {
            if (!currentBook || !audio.currentTime) return;
            const key = `${currentBook.id}_${currentChapter}`;
            bookmarks[key] = audio.currentTime;
            saveData();
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            renderQuickRecommendations();
        }

        function createBookmark() {
            if (!currentBook || !audio.currentTime) return;
            saveProgress();
            showSuccess(`–ó–∞–∫–ª–∞–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ ${formatTime(audio.currentTime)}`);
        }

        // Library functions - improved with better styling
        function renderLibrary() {
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const filteredBooks = audiobooks.filter(book => 
                book && book.title && book.author &&
                (book.title.toLowerCase().includes(searchTerm) ||
                 book.author.toLowerCase().includes(searchTerm))
            );

            libraryTitle.textContent = `–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ (${filteredBooks.length})`;

            if (filteredBooks.length === 0) {
                if (searchTerm) {
                    booksList.innerHTML = `
                        <div class="text-center py-16">
                            <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-gray-500/20 to-gray-600/20 rounded-3xl flex items-center justify-center">
                                <i data-lucide="search-x" class="w-10 h-10 text-white/40"></i>
                            </div>
                            <h4 class="text-xl text-white/60 mb-4">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                            <p class="text-white/50 mb-6">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>
                            <button onclick="searchInput.value=''; renderLibrary();" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                                –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏
                            </button>
                        </div>
                    `;
                } else {
                    booksList.innerHTML = emptyLibrary.outerHTML;
                }
                return;
            }

            const booksHtml = filteredBooks.map(book => {
                const isCurrentBook = currentBook?.id === book.id;
                const hasProgress = Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 60;
                });
                
                return `
                    <div class="book-card p-6 rounded-3xl border cursor-pointer ${
                        isCurrentBook 
                            ? 'bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-blue-400/40' 
                            : 'bg-white/10 border-white/20 hover:bg-white/15'
                    }" onclick="selectBook(${book.id})">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                ${book.cover ? 
                                    `<img src="${book.cover}" alt="${book.title}" class="w-16 h-20 sm:w-20 sm:h-28 rounded-2xl object-cover shadow-lg border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                    ''}
                                <div class="w-16 h-20 sm:w-20 sm:h-28 rounded-2xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/30 flex flex-col items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                    <i data-lucide="music" class="w-6 h-6 text-white/60 mb-2"></i>
                                    <span class="text-white/50 text-xs text-center px-1 leading-tight line-clamp-2">
                                        ${book.title}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white text-lg mb-2 line-clamp-2">
                                    ${book.title}
                                </h4>
                                <p class="text-white/70 text-sm mb-3 line-clamp-1">${book.author}</p>
                                
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-sm text-white/60 space-x-4">
                                        <div class="flex items-center space-x-1">
                                            <i data-lucide="headphones" class="w-4 h-4"></i>
                                            <span>${book.chapters.length} –≥–ª–∞–≤</span>
                                        </div>
                                        
                                        ${hasProgress ? `
                                            <div class="flex items-center space-x-1 text-yellow-400">
                                                <i data-lucide="bookmark-check" class="w-4 h-4"></i>
                                                <span>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                                            </div>
                                        ` : ''}
                                        
                                        ${book.series ? `
                                            <div class="flex items-center space-x-1 text-purple-400">
                                                <i data-lucide="layers" class="w-4 h-4"></i>
                                                <span>${book.series} #${book.seriesOrder || 1}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        <button onclick="event.stopPropagation(); editBook(${book.id})" class="btn-secondary p-2 rounded-xl hover-lift" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteBook(${book.id})" class="bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 p-2 rounded-xl hover-lift transition-all" title="–£–¥–∞–ª–∏—Ç—å">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            booksList.innerHTML = booksHtml;
            lucide.createIcons();
        }

        function deleteBook(bookId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∞—É–¥–∏–æ–∫–Ω–∏–≥—É –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏?')) return;
            
            if (!audiobooks || !Array.isArray(audiobooks)) {
                showError('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            audiobooks = audiobooks.filter(book => book && book.id !== bookId);
            if (currentBook?.id === bookId) {
                currentBook = null;
                audio.pause();
                isPlaying = false;
                updatePlayer();
            }
            
            saveData();
            renderLibrary();
            renderQuickRecommendations();
            showSuccess('–ö–Ω–∏–≥–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏!');
        }

        // Enhanced chapter management
        function addChapter() {
            const container = document.getElementById('chaptersContainer');
            const chapterCount = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-white font-medium">–ì–ª–∞–≤–∞ ${chapterCount}</span>
                    <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <input type="url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Ñ–∞–π–ª" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
            `;
            container.appendChild(div);
            lucide.createIcons();
            updateChapterButtons();
        }

        function removeChapter(button) {
            if (document.querySelectorAll('.chapter-input').length > 1) {
                button.closest('.chapter-input').remove();
                updateChapterNumbers();
                updateChapterButtons();
            }
        }

        function updateChapterNumbers() {
            const chapters = document.querySelectorAll('.chapter-input');
            chapters.forEach((chapter, index) => {
                const span = chapter.querySelector('span');
                const input = chapter.querySelector('input');
                if (span) span.textContent = `–ì–ª–∞–≤–∞ ${index + 1}`;
                if (input) input.placeholder = `–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Ñ–∞–π–ª –≥–ª–∞–≤—ã ${index + 1}`;
            });
        }

        function updateChapterButtons() {
            const buttons = document.querySelectorAll('.chapter-input button');
            buttons.forEach((button, index) => {
                if (buttons.length === 1) {
                    button.style.opacity = '0.5';
                    button.disabled = true;
                } else {
                    button.style.opacity = '1';
                    button.disabled = false;
                }
            });
        }

        function resetAddForm() {
            document.getElementById('newBookTitle').value = '';
            document.getElementById('newBookAuthor').value = '';
            document.getElementById('newBookCover').value = '';
            document.getElementById('newBookSeries').value = '';
            document.getElementById('newBookSeriesOrder').value = '1';
            
            const container = document.getElementById('chaptersContainer');
            container.innerHTML = `
                <div class="chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">–ì–ª–∞–≤–∞ 1</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg opacity-50" disabled>
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Ñ–∞–π–ª" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            `;
            
            // Clear bulk links
            const bulkContainer = document.getElementById('bulkLinksContainer');
            const bulkText = document.getElementById('bulkLinksText');
            if (bulkContainer) bulkContainer.classList.add('hidden');
            if (bulkText) bulkText.value = '';
            
            lucide.createIcons();
        }

        // Enhanced add book function
        function addBook() {
            const titleElement = document.getElementById('newBookTitle');
            const authorElement = document.getElementById('newBookAuthor');
            const coverElement = document.getElementById('newBookCover');
            const seriesElement = document.getElementById('newBookSeries');
            const seriesOrderElement = document.getElementById('newBookSeriesOrder');
            
            if (!titleElement || !authorElement) {
                showError('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã');
                return;
            }
            
            const title = safeStringTrim(titleElement.value);
            const author = safeStringTrim(authorElement.value) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä';
            const cover = coverElement ? safeStringTrim(coverElement.value) : '';
            const series = seriesElement ? safeStringTrim(seriesElement.value) : '';
            const seriesOrder = seriesOrderElement ? parseInt(seriesOrderElement.value) || 1 : 1;
            
            if (!title) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏');
                return;
            }

            const chapterInputs = document.querySelectorAll('.chapter-input input[type="url"]');
            const chapters = [];
            
            chapterInputs.forEach((input, index) => {
                const url = safeStringTrim(input.value);
                if (url) {
                    chapters.push({
                        title: `–ì–ª–∞–≤–∞ ${index + 1}`,
                        url: url
                    });
                }
            });

            if (chapters.length === 0) {
                showError('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥–ª–∞–≤—É');
                return;
            }

            const audiobook = {
                id: Date.now(),
                title: title,
                author: author,
                cover: cover || null,
                chapters: chapters,
                addedDate: new Date().toISOString(),
                series: series || null,
                seriesOrder: series ? seriesOrder : null
            };

            audiobooks.push(audiobook);
            saveData();
            renderLibrary();
            renderQuickRecommendations();
            updateSeriesFilter();
            checkAchievements();
            closeModal('addModal');
            showSuccess(`–ö–Ω–∏–≥–∞ "${title}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É!`);
        }

        // Enhanced bulk links functionality
        function toggleBulkLinks() {
            const container = document.getElementById('bulkLinksContainer');
            container.classList.toggle('hidden');
            
            if (!container.classList.contains('hidden')) {
                document.getElementById('bulkLinksText').focus();
            }
        }

        function processBulkLinks() {
            const text = document.getElementById('bulkLinksText').value;
            if (!safeStringTrim(text)) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≥–ª–∞–≤—ã');
                return;
            }

            const links = text
                .split('\n')
                .map(line => safeStringTrim(line))
                .filter(line => line && (line.startsWith('http') || line.startsWith('https')));

            if (links.length === 0) {
                showError('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Å—ã–ª–æ–∫');
                return;
            }

            // Clear existing chapters and add new ones
            const container = document.getElementById('chaptersContainer');
            container.innerHTML = '';

            links.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">–ì–ª–∞–≤–∞ ${index + 1}</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="url" value="${url}" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                `;
                container.appendChild(div);
            });

            clearBulkLinks();
            lucide.createIcons();
            updateChapterButtons();
            showSuccess(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${links.length} —Å—Å—ã–ª–æ–∫ –Ω–∞ –≥–ª–∞–≤—ã!`);
        }

        function clearBulkLinks() {
            const bulkLinksElement = document.getElementById('bulkLinksText');
            const containerElement = document.getElementById('bulkLinksContainer');
            
            if (bulkLinksElement) {
                bulkLinksElement.value = '';
            }
            if (containerElement) {
                containerElement.classList.add('hidden');
            }
        }

        // File upload functionality
        function handleFileUpload(event) {
            const files = Array.from(event.target.files).filter(file => 
                file.type === 'audio/mpeg' || file.type === 'audio/mp3' || file.name.toLowerCase().endsWith('.mp3')
            );

            if (files.length === 0) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ MP3 —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
                return;
            }

            showUploadProgress();
            
            // Clear existing chapters
            document.getElementById('chaptersContainer').innerHTML = '';

            files.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

            files.forEach((file, index) => {
                updateProgress(((index + 1) / files.length) * 100);

                const fileUrl = URL.createObjectURL(file);
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                
                const div = document.createElement('div');
                div.className = 'chapter-input bg-white/5 border border-white/20 rounded-2xl p-4 mb-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-medium">–ì–ª–∞–≤–∞ ${index + 1}</span>
                        <button onclick="removeChapter(this)" class="btn-secondary p-1 rounded-lg">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <input type="text" value="${fileName}" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white mb-2 text-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã">
                    <input type="url" value="${fileUrl}" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                `;
                document.getElementById('chaptersContainer').appendChild(div);
            });

            hideUploadProgress();
            lucide.createIcons();
            updateChapterButtons();
            showSuccess(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤!`);
            event.target.value = '';
        }

        function showUploadProgress() {
            document.getElementById('uploadProgress').classList.remove('hidden');
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').classList.add('hidden');
            updateProgress(0);
        }

        function updateProgress(percentage) {
            const progressBar = document.querySelector('#uploadProgress #progressBar');
            const progressText = document.getElementById('progressText');
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressText) progressText.textContent = Math.round(percentage) + '%';
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('border-blue-400/60', 'bg-blue-500/20');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-400/60', 'bg-blue-500/20');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-400/60', 'bg-blue-500/20');

                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.type === 'audio/mpeg' || file.type === 'audio/mp3' || file.name.toLowerCase().endsWith('.mp3')
                );

                if (files.length === 0) {
                    showError('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ MP3 —Ñ–∞–π–ª—ã');
                    return;
                }

                const fakeEvent = { target: { files: files, value: '' } };
                handleFileUpload(fakeEvent);
            });
        }

        // Import/Export functionality
        function exportData() {
            try {
                const data = {
                    audiobooks: audiobooks || [],
                    bookmarks: bookmarks || {},
                    achievements: achievements || [],
                    exportDate: new Date().toISOString(),
                    version: "2.0"
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audiobook-library-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setStorageItem('exported_library', 'true');
                showSuccess('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
            } catch (error) {
                console.error('Export error:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç –≤—Å–µ –∞—É–¥–∏–æ–∫–Ω–∏–≥–∏, –∑–∞–∫–ª–∞–¥–∫–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
            if (!confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ! –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ –ø–æ—Ç–µ—Ä—è–Ω—ã.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
            
            try {
                audiobooks = [];
                bookmarks = {};
                achievements = [];
                currentBook = null;
                currentChapter = 0;
                
                audio.pause();
                audio.src = '';
                isPlaying = false;
                
                // Clear localStorage safely
                const storage = safeLocalStorage();
                if (storage) {
                    storage.clear();
                }
                
                updatePlayer();
                renderLibrary();
                renderQuickRecommendations();
                updateAchievementBadge();
                closeModal('settingsModal');
                
                showSuccess('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã!');
            } catch (error) {
                console.error('Error clearing data:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        // Open Link Collector
        function openLinkCollector() {
            window.open('https://vteme1.github.io/Link-Collection-Manager', '_blank');
            showSuccess('–°–±–æ—Ä—â–∏–∫ —Å—Å—ã–ª–æ–∫ –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ!');
        }

        // Enhanced recommendations rendering
        function renderQuickRecommendations() {
            const container = document.getElementById('quickRecommendations');
            const block = document.getElementById('recommendationsBlock');
            
            if (!container || !block) return;
            
            const recommendations = generateQuickRecommendations();
            block.classList.remove('hidden');
            
            if (recommendations.length === 0 || (recommendations.length === 1 && recommendations[0].type === 'getting_started')) {
                container.innerHTML = `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl flex items-center justify-center">
                            <i data-lucide="lightbulb" class="w-8 h-8 text-white/40"></i>
                        </div>
                        <h4 class="text-white font-semibold text-lg mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h4>
                        <p class="text-white/70 mb-6">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ –∞—É–¥–∏–æ–∫–Ω–∏–≥–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
                        <button onclick="openModal('addModal')" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∫–Ω–∏–≥—É
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            let html = '';
            recommendations.forEach(rec => {
                html += `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-white font-bold text-lg flex items-center">
                                <span class="text-2xl mr-3">${rec.icon}</span>
                                ${rec.title}
                            </h4>
                            ${rec.books.length > 0 ? `
                                <span class="text-white/60 text-sm bg-white/20 px-3 py-1 rounded-full font-medium">
                                    ${rec.books.length} ${rec.books.length === 1 ? '–∫–Ω–∏–≥–∞' : rec.books.length < 5 ? '–∫–Ω–∏–≥–∏' : '–∫–Ω–∏–≥'}
                                </span>
                            ` : ''}
                        </div>
                        <p class="text-white/70 mb-6">${rec.reason}</p>
                        
                        <div class="grid gap-3">
                            ${rec.books.slice(0, 3).map(book => `
                                <div class="flex items-center space-x-4 p-4 bg-white/5 border border-white/10 rounded-xl hover:bg-white/10 transition-all cursor-pointer hover-lift" onclick="selectBook(${book.id}); scrollToPlayer();">
                                    <div class="flex-shrink-0">
                                        ${book.cover ? 
                                            `<img src="${book.cover}" alt="${book.title}" class="w-12 h-16 rounded-xl object-cover border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                            ''}
                                        <div class="w-12 h-16 rounded-xl bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/30 flex items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                            <i data-lucide="music" class="w-5 h-5 text-white/60"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h5 class="text-white font-semibold text-sm line-clamp-2 mb-1">${book.title}</h5>
                                        <p class="text-white/60 text-sm line-clamp-1 mb-2">${book.author}</p>
                                        ${book.progress ? `
                                            <div class="flex items-center space-x-2">
                                                <div class="flex-1 bg-white/20 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-blue-400 to-purple-400 h-2 rounded-full" style="width: ${book.progress}%"></div>
                                                </div>
                                                <span class="text-white/50 text-xs font-medium">${book.progress}%</span>
                                            </div>
                                        ` : `
                                            <div class="flex items-center text-white/50 text-xs">
                                                <i data-lucide="headphones" class="w-3 h-3 mr-1"></i>
                                                <span>${book.chapters.length} –≥–ª–∞–≤</span>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                            ${rec.books.length > 3 ? `
                                <button onclick="openModal('recommendationsModal')" class="text-center p-3 text-white/60 hover:text-white text-sm hover:bg-white/5 rounded-xl transition-all border border-white/10 hover:border-white/20">
                                    <i data-lucide="more-horizontal" class="w-4 h-4 mr-2"></i>
                                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ ${rec.books.length} –∫–Ω–∏–≥
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function generateQuickRecommendations() {
            if (audiobooks.length === 0) {
                return [{
                    type: 'getting_started',
                    title: '–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ',
                    icon: 'üåü',
                    books: [],
                    reason: '–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ –∞—É–¥–∏–æ–∫–Ω–∏–≥–∏ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –º–∏—Ä –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö –∏—Å—Ç–æ—Ä–∏–π'
                }];
            }
            
            const recommendations = [];
            
            // Continue reading - –∫–Ω–∏–≥–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
            const unfinishedBooks = audiobooks.filter(book => {
                const hasProgress = Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 60;
                });
                
                const lastChapterKey = `${book.id}_${book.chapters.length - 1}`;
                const isCompleted = bookmarks[lastChapterKey] && bookmarks[lastChapterKey] > 300;
                
                return hasProgress && !isCompleted;
            }).map(book => {
                // Calculate progress
                const bookKeys = Object.keys(bookmarks).filter(key => key.startsWith(`${book.id}_`));
                const totalChapters = book.chapters.length;
                const chaptersWithProgress = bookKeys.length;
                const progress = Math.min(100, Math.round((chaptersWithProgress / totalChapters) * 100));
                
                return { ...book, progress };
            }).sort((a, b) => b.progress - a.progress);
            
            if (unfinishedBooks.length > 0) {
                recommendations.push({
                    type: 'continue',
                    title: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ',
                    icon: 'üìñ',
                    books: unfinishedBooks,
                    reason: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –Ω–∞—á–∞—Ç—ã–µ –∏—Å—Ç–æ—Ä–∏–∏'
                });
            }
            
            // New books - –∫–Ω–∏–≥–∏ –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const newBooks = audiobooks.filter(book => {
                return !Object.keys(bookmarks).some(key => {
                    const [bookId] = key.split('_');
                    return parseInt(bookId) === book.id && bookmarks[key] > 30;
                });
            });
            
            if (newBooks.length > 0 && recommendations.length === 0) {
                recommendations.push({
                    type: 'new',
                    title: '–ù–æ–≤—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
                    icon: '‚ú®',
                    books: newBooks,
                    reason: '–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏'
                });
            }
            
            return recommendations.slice(0, 2);
        }

        function toggleRecommendationsBlock() {
            const block = document.getElementById('recommendationsBlock');
            block.style.transform = 'translateY(-20px)';
            block.style.opacity = '0';
            setTimeout(() => {
                block.classList.add('hidden');
            }, 200);
            setStorageItem('recommendations_hidden', true);
        }

        function scrollToPlayer() {
            const playerSection = document.getElementById('playerSection');
            if (playerSection && !playerSection.classList.contains('hidden')) {
                playerSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Achievement system and other functions remain the same but will be added in next response due to length...
        
        // Initialize everything when DOM is ready
        function initializeApp() {
            try {
                initializeData();
                renderLibrary();
                renderQuickRecommendations();
                updatePlayer();
                setupSearch();
                setupFileUploadHandler();
                setupDragAndDrop();
                setupAudioEventListeners();
                setupVolumeAndSpeedControls();
                
                // Initialize icons
                lucide.createIcons();
                
                console.log('–ê—É–¥–∏–æ–ø–ª–µ–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            }
        }

        function setupSearch() {
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value;
                    const clearBtn = document.getElementById('clearSearchBtn');
                    
                    if (searchQuery.trim()) {
                        clearBtn.classList.remove('hidden');
                    } else {
                        clearBtn.classList.add('hidden');
                    }
                    
                    renderLibrary();
                });
            }
        }

        function clearSearch() {
            searchQuery = '';
            searchInput.value = '';
            document.getElementById('clearSearchBtn').classList.add('hidden');
            renderLibrary();
        }

        function setupFileUploadHandler() {
            const massUploadElement = document.getElementById('massUpload');
            if (massUploadElement) {
                massUploadElement.addEventListener('change', handleFileUpload);
            }
        }

        function setupAudioEventListeners() {
            // Audio event listeners
            audio.addEventListener('play', () => {
                console.log('Audio play event fired');
                isPlaying = true;
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                setTimeout(() => {
                    updatePlayButton();
                }, 50);
            });

            audio.addEventListener('pause', () => {
                console.log('Audio pause event fired');
                isPlaying = false;
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                setTimeout(() => {
                    updatePlayButton();
                    saveProgress();
                }, 50);
            });

            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFill.style.width = progress + '%';
                    currentTimeSpan.textContent = formatTime(audio.currentTime);
                    
                    // Auto-save progress every 10 seconds
                    if (Math.floor(audio.currentTime) % 10 === 0) {
                        saveProgress();
                    }
                }
            });

            audio.addEventListener('loadedmetadata', () => {
                durationSpan.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('ended', () => {
                if (currentChapter < currentBook.chapters.length - 1) {
                    nextChapter();
                } else {
                    isPlaying = false;
                    updatePlayButton();
                }
            });

            audio.addEventListener('error', (e) => {
                console.error('Audio error:', e);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª.');
                isPlaying = false;
                updatePlayButton();
            });

            // Progress bar click
            progressBar.addEventListener('click', (e) => {
                if (!audio.duration) return;
                const rect = progressBar.getBoundingClientRect();
                const percentage = ((e.clientX - rect.left) / rect.width) * 100;
                seekTo(percentage);
            });

            // Chapter selector
            chapterSelect.addEventListener('change', () => {
                currentChapter = parseInt(chapterSelect.value);
                loadChapter();
                updateControls();
            });
        }

        function setupVolumeAndSpeedControls() {
            // Volume slider
            volumeSlider.addEventListener('input', () => {
                const volume = volumeSlider.value;
                audio.volume = volume;
                volumeDisplay.textContent = Math.round(volume * 100) + '%';
            });

            // Speed selector
            speedSelect.addEventListener('change', () => {
                audio.playbackRate = speedSelect.value;
            });
        }

        // Series functionality
        function getAllSeries() {
            const seriesMap = new Map();
            
            if (!audiobooks || !Array.isArray(audiobooks)) return [];
            
            audiobooks.forEach(book => {
                if (book && book.series && typeof book.series === 'string' && safeStringTrim(book.series)) {
                    const seriesName = safeStringTrim(book.series);
                    if (!seriesMap.has(seriesName)) {
                        seriesMap.set(seriesName, {
                            name: seriesName,
                            books: [],
                            author: book.author || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä',
                            totalChapters: 0
                        });
                    }
                    
                    const series = seriesMap.get(seriesName);
                    series.books.push(book);
                    series.totalChapters += (book.chapters && Array.isArray(book.chapters)) ? book.chapters.length : 0;
                }
            });
            
            seriesMap.forEach(series => {
                series.books.sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            });
            
            return Array.from(seriesMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        }

        function getNextBookInSeries(book) {
            if (!book?.series || !audiobooks || !Array.isArray(audiobooks)) return null;
            
            const seriesBooks = audiobooks
                .filter(b => b && b.series === book.series)
                .sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            
            const currentIndex = seriesBooks.findIndex(b => b && b.id === book.id);
            return currentIndex >= 0 && currentIndex < seriesBooks.length - 1 ? seriesBooks[currentIndex + 1] : null;
        }

        function getPrevBookInSeries(book) {
            if (!book?.series || !audiobooks || !Array.isArray(audiobooks)) return null;
            
            const seriesBooks = audiobooks
                .filter(b => b && b.series === book.series)
                .sort((a, b) => (a.seriesOrder || 1) - (b.seriesOrder || 1));
            
            const currentIndex = seriesBooks.findIndex(b => b && b.id === book.id);
            return currentIndex > 0 ? seriesBooks[currentIndex - 1] : null;
        }

        function goToNextBookInSeries() {
            const nextBook = getNextBookInSeries(currentBook);
            if (nextBook) {
                selectBook(nextBook.id);
                showSuccess(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "${nextBook.title}"`);
            }
        }

        function goToPrevBookInSeries() {
            const prevBook = getPrevBookInSeries(currentBook);
            if (prevBook) {
                selectBook(prevBook.id);
                showSuccess(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "${prevBook.title}"`);
            }
        }

        function toggleSeriesView() {
            showSeriesView = !showSeriesView;
            const btn = document.getElementById('seriesViewBtn');
            
            if (showSeriesView) {
                btn.classList.add('bg-blue-500/30', 'border-blue-400/50');
                btn.classList.remove('bg-white/10', 'border-white/20');
                renderSeriesView();
            } else {
                btn.classList.remove('bg-blue-500/30', 'border-blue-400/50');
                btn.classList.add('bg-white/10', 'border-white/20');
                renderLibrary();
            }
        }

        function renderSeriesView() {
            const allSeries = getAllSeries();
            
            if (allSeries.length === 0) {
                booksList.innerHTML = `
                    <div class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="layers" class="w-12 h-12 text-white/40"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">–ù–µ—Ç —Å–µ—Ä–∏–π –∫–Ω–∏–≥</h4>
                        <p class="text-white/50 mb-6">–î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ä–∏—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏</p>
                        <button onclick="openModal('addModal')" class="btn-primary px-6 py-3 rounded-xl hover-lift">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É —Å —Å–µ—Ä–∏–µ–π
                        </button>
                    </div>
                `;
                return;
            }

            let seriesHtml = '';
            
            allSeries.forEach(series => {
                seriesHtml += `
                    <div class="bg-gradient-to-r from-white/5 to-white/10 border border-white/20 rounded-3xl p-6 hover-lift">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h4 class="text-white font-bold text-xl flex items-center mb-2">
                                    <div class="p-2 bg-gradient-to-br from-purple-500/30 to-pink-500/30 rounded-xl mr-3">
                                        <i data-lucide="layers" class="w-6 h-6"></i>
                                    </div>
                                    ${series.name}
                                </h4>
                                <p class="text-white/60">
                                    ${series.author} ‚Ä¢ ${series.books.length} –∫–Ω–∏–≥ ‚Ä¢ ${series.totalChapters} –≥–ª–∞–≤
                                </p>
                            </div>
                            <button onclick="filterBySeries('${series.name}'); toggleSeriesView();" class="btn-primary px-4 py-2 rounded-xl hover-lift">
                                –û—Ç–∫—Ä—ã—Ç—å —Å–µ—Ä–∏—é
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${series.books.slice(0, 6).map(book => `
                                <div class="flex items-center space-x-3 p-3 bg-white/5 border border-white/10 rounded-xl cursor-pointer hover:bg-white/10 transition-all hover-lift" onclick="selectBook(${book.id}); toggleSeriesView();">
                                    <div class="flex-shrink-0">
                                        ${book.cover ? 
                                            `<img src="${book.cover}" alt="${book.title}" class="w-10 h-14 rounded-lg object-cover border border-white/20" onerror="this.style.display='none'; this.nextSibling.style.display='flex';">` : 
                                            ''}
                                        <div class="w-10 h-14 rounded-lg bg-gradient-to-br from-purple-500/30 to-pink-500/30 border border-white/20 flex items-center justify-center ${book.cover ? 'hidden' : 'flex'}">
                                            <span class="text-white/60 text-xs font-bold">#${book.seriesOrder || 1}</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-white text-sm font-semibold line-clamp-2 mb-1">
                                            #${book.seriesOrder || 1}. ${book.title}
                                        </p>
                                        <p class="text-white/50 text-xs">${book.chapters.length} –≥–ª–∞–≤</p>
                                    </div>
                                </div>
                            `).join('')}
                            ${series.books.length > 6 ? `
                                <div class="flex items-center justify-center p-3 text-white/40 text-sm border border-white/10 rounded-xl">
                                    +${series.books.length - 6} –µ—â–µ...
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            booksList.innerHTML = seriesHtml;
            lucide.createIcons();
        }

        function updateSeriesFilter() {
            // This function can be enhanced later for series filtering
        }

        function filterBySeries(seriesName) {
            // This function can be enhanced later for series filtering
        }

        // Basic edit functionality
        function editBook(bookId) {
            const book = audiobooks.find(b => b.id === bookId);
            if (!book) return;
            
            editingBook = { ...book, chapters: book.chapters.map(ch => ({ ...ch })) };
            
            document.getElementById('editBookTitle').value = book.title || '';
            document.getElementById('editBookAuthor').value = book.author || '';
            document.getElementById('editBookCover').value = book.cover || '';
            document.getElementById('editBookSeries').value = book.series || '';
            document.getElementById('editBookSeriesOrder').value = book.seriesOrder || 1;
            
            renderEditChapters();
            openModal('editModal');
        }

        function renderEditChapters() {
            const container = document.getElementById('editChaptersContainer');
            
            let html = '';
            editingBook.chapters.forEach((chapter, index) => {
                html += `
                    <div class="bg-white/5 border border-white/20 rounded-2xl p-4 mb-3" data-chapter-index="${index}">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-white font-medium">–ì–ª–∞–≤–∞ ${index + 1}</span>
                            ${editingBook.chapters.length > 1 ? `
                                <button onclick="removeEditChapter(${index})" class="bg-red-500/20 border border-red-400/40 text-red-300 hover:bg-red-500/30 p-1 rounded-lg transition-all">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            ` : ''}
                        </div>
                        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã" value="${chapter.title || ''}" onchange="updateEditChapter(${index}, 'title', this.value)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-3">
                        <input type="url" placeholder="MP3 —Å—Å—ã–ª–∫–∞" value="${chapter.url || ''}" onchange="updateEditChapter(${index}, 'url', this.value)" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                `;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function addEditChapter() {
            editingBook.chapters.push({
                title: `–ì–ª–∞–≤–∞ ${editingBook.chapters.length + 1}`,
                url: ''
            });
            renderEditChapters();
        }

        function removeEditChapter(index) {
            if (editingBook.chapters.length > 1) {
                editingBook.chapters.splice(index, 1);
                renderEditChapters();
            }
        }

        function updateEditChapter(index, field, value) {
            if (editingBook.chapters[index]) {
                editingBook.chapters[index][field] = value;
            }
        }

        function saveEditedBook() {
            if (!safeStringTrim(editingBook.title)) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏');
                return;
            }

            editingBook.title = safeStringTrim(document.getElementById('editBookTitle').value);
            editingBook.author = safeStringTrim(document.getElementById('editBookAuthor').value) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä';
            editingBook.cover = safeStringTrim(document.getElementById('editBookCover').value) || null;
            editingBook.series = safeStringTrim(document.getElementById('editBookSeries').value) || null;
            editingBook.seriesOrder = parseInt(document.getElementById('editBookSeriesOrder').value) || 1;

            const validChapters = editingBook.chapters.filter(ch => 
                ch && ch.url && safeStringTrim(ch.url)
            );

            if (validChapters.length === 0) {
                showError('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥–ª–∞–≤—É');
                return;
            }

            editingBook.chapters = validChapters;

            const bookIndex = audiobooks.findIndex(book => book.id === editingBook.id);
            if (bookIndex !== -1) {
                audiobooks[bookIndex] = editingBook;
                
                if (currentBook?.id === editingBook.id) {
                    currentBook = editingBook;
                    if (currentChapter >= editingBook.chapters.length) {
                        currentChapter = 0;
                    }
                    updatePlayer();
                }
                
                saveData();
                renderLibrary();
                closeModal('editModal');
                showSuccess('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
            }
        }

        // Basic bookmark and achievement systems
        function renderBookmarks() {
            const container = document.getElementById('bookmarksList');
            
            const allBookmarks = Object.entries(bookmarks)
                .map(([key, time]) => {
                    const [bookId, chapterIndex] = key.split('_');
                    const book = audiobooks.find(b => b.id === parseInt(bookId));
                    if (!book || time <= 0) return null;
                    
                    return {
                        bookId: parseInt(bookId),
                        chapterIndex: parseInt(chapterIndex),
                        time,
                        bookTitle: book.title,
                        bookAuthor: book.author,
                        chapterTitle: book.chapters[parseInt(chapterIndex)]?.title || `–ì–ª–∞–≤–∞ ${parseInt(chapterIndex) + 1}`
                    };
                })
                .filter(Boolean)
                .sort((a, b) => b.time - a.time);
            
            if (allBookmarks.length === 0) {
                container.innerHTML = `
                    <div id="emptyBookmarks" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="bookmark-check" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–ª–∞–¥–æ–∫</h4>
                        <p class="text-white/50 max-w-sm mx-auto">–ó–∞–∫–ª–∞–¥–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∏–ª–∏ –≤—Ä—É—á–Ω—É—é</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            allBookmarks.forEach(bookmark => {
                html += `
                    <div class="bg-white/10 border border-white/20 rounded-2xl p-6 hover:bg-white/15 transition-all hover-lift">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0 mr-4">
                                <h4 class="text-white font-semibold text-lg mb-2 line-clamp-2">
                                    ${bookmark.bookTitle}
                                </h4>
                                <p class="text-white/60 mb-3 line-clamp-1">
                                    ${bookmark.bookAuthor} ‚Ä¢ ${bookmark.chapterTitle}
                                </p>
                                <div class="flex items-center text-yellow-400 mb-3">
                                    <i data-lucide="bookmark-check" class="w-5 h-5 mr-2"></i>
                                    <span class="font-medium">${formatTime(bookmark.time)}</span>
                                </div>
                            </div>
                            
                            <button onclick="jumpToBookmark(${bookmark.bookId}, ${bookmark.chapterIndex}, ${bookmark.time})" class="btn-primary px-4 py-2 rounded-xl hover-lift whitespace-nowrap">
                                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                                –ü–µ—Ä–µ–π—Ç–∏
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button onclick="clearAllBookmarks()" class="w-full bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-400/40 rounded-2xl py-4 text-red-200 hover:from-red-500/30 hover:to-orange-500/30 transition-all hover-lift">
                    <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–∫–ª–∞–¥–∫–∏
                </button>
            `;
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function jumpToBookmark(bookId, chapterIndex, time) {
            if (!audiobooks || !Array.isArray(audiobooks)) return;
            
            const book = audiobooks.find(b => b && b.id === bookId);
            if (!book) {
                showError('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            selectBook(bookId);
            currentChapter = Math.max(0, chapterIndex);
            
            setTimeout(() => {
                try {
                    if (audio.duration && time >= 0 && time <= audio.duration) {
                        audio.currentTime = time;
                    }
                    updatePlayer();
                } catch (error) {
                    console.error('Error jumping to bookmark:', error);
                }
            }, 500);
            
            closeModal('bookmarksModal');
            showSuccess(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–∞–∫–ª–∞–¥–∫–µ –≤ "${book.title}"`);
        }

        function clearAllBookmarks() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–ª–∞–¥–∫–∏?')) {
                bookmarks = {};
                saveData();
                renderBookmarks();
                showSuccess('–í—Å–µ –∑–∞–∫–ª–∞–¥–∫–∏ –æ—á–∏—â–µ–Ω—ã!');
            }
        }

        // Basic achievement and recommendation systems
        function renderAchievements() {
            const container = document.getElementById('unlockedAchievements');
            if (container) {
                container.innerHTML = `
                    <div id="emptyAchievements" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="trophy" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h4>
                        <p class="text-white/50 max-w-md mx-auto">–°–ª—É—à–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –∏ –∏—Å—Å–ª–µ–¥—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–µ–µ—Ä–∞, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã!</p>
                    </div>
                `;
            }
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendationsList');
            if (container) {
                container.innerHTML = `
                    <div id="emptyRecommendations" class="text-center py-16">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-3xl flex items-center justify-center">
                            <i data-lucide="lightbulb" class="w-12 h-12 text-white/30"></i>
                        </div>
                        <h4 class="text-xl text-white/60 mb-4">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</h4>
                        <p class="text-white/50 max-w-md mx-auto">–ü–æ—Å–ª—É—à–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π!</p>
                    </div>
                `;
            }
        }

        function checkAchievements() {
            // Basic achievement check - can be expanded
        }

        function updateAchievementBadge() {
            // Basic badge update - can be expanded
        }

        function hideAchievementNotification() {
            document.getElementById('achievementNotification').classList.add('hidden');
        }

        // Setup import handler
        function setupImportHandler() {
            const importFileElement = document.getElementById('importFile');
            if (importFileElement) {
                importFileElement.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.audiobooks || !Array.isArray(data.audiobooks)) {
                                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                            }

                            const importChoice = confirm(
                                `–ù–∞–π–¥–µ–Ω–æ ${data.audiobooks.length} –∫–Ω–∏–≥.\n\n` +
                                '–û–ö - –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É\n' +
                                '–û—Ç–º–µ–Ω–∞ - –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ'
                            );

                            if (importChoice) {
                                audiobooks = data.audiobooks;
                                if (data.bookmarks) bookmarks = data.bookmarks;
                                showSuccess(`–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–º–µ–Ω–µ–Ω–∞! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${data.audiobooks.length} –∫–Ω–∏–≥.`);
                            } else {
                                const existingIds = new Set(audiobooks.map(book => book.id));
                                const newBooks = data.audiobooks.filter(book => !existingIds.has(book.id));
                                
                                if (newBooks.length === 0) {
                                    showError('–í—Å–µ –∫–Ω–∏–≥–∏ —É–∂–µ –µ—Å—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ!');
                                    return;
                                }

                                audiobooks.push(...newBooks);
                                if (data.bookmarks) {
                                    Object.assign(bookmarks, data.bookmarks);
                                }
                                showSuccess(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${newBooks.length} –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥!`);
                            }

                            saveData();
                            renderLibrary();
                            renderQuickRecommendations();
                            
                            if (currentBook && !audiobooks.some(book => book.id === currentBook.id)) {
                                currentBook = null;
                                updatePlayer();
                            }

                        } catch (error) {
                            console.error('Import error:', error);
                            showError('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.');
                        }
                    };
                    
                    reader.readAsText(file);
                    e.target.value = '';
                });
            }
        }

        // Wait for DOM to be ready, then initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

    </script>
</body>
</html>
